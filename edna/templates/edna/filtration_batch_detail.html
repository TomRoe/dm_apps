{% extends 'edna/base.html' %}
{% load verbose_names %}
{% load i18n %}

{% block subcontent %}

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <style>
  .my-btn {
      font-size: small;
  }

  #map {
      height: 300px; /* The height is 400 pixels */
      width: 100%; /* The width is the width of the web page */
  }

  .no-borders {
      border: 0;
      width: 100%;
  }

  .no-borders:focus {
      outline: none;
  }

  </style>

  <div class="btns mb-3">
    <a href="{% url 'edna:filtration_batch_edit' object.id %}" class="btn btn-warning btn-sm">{% trans "Edit" %}</a>
    <a href="{% url 'edna:filtration_batch_delete' object.id %}" class="btn btn-danger btn-sm">{% trans "Delete" %}</a>

  </div>

  <table class="table table-sm">
    {% for field in field_list %}
      {% verbose_td_display object field th_width="200px" %}
    {% endfor %}
  </table>

  <div id="app" class="mt-5">
    <div class="mb-3">
      <p class="h3">{% trans "Filters" %}</p>
      <button @click="addFilter(null)" class="btn btn-sm btn-primary">{% trans "Add a Filter" %}</button>
      <button @click="addFilter('all')" class="btn btn-sm btn-warning">{% trans "Add all un-filtered samples" %}</button>
    </div>

    <div v-if="loading" class="loading mb-3 mt-3 mt-5">
      <div class="spinner-border mb-3" style="width: 5rem; height: 5rem;" role="status">
        <span class="sr-only"></span>
      </div>
    </div>
    <div v-else-if="!filters.length">
      <em>{% trans "No filters have been added to this batch." %}</em>
    </div>
    <div v-else>
      <div class="alert alert-danger" role="alert" v-if="filterErrorMsg">
        <p class="mb-0 lead" v-html="filterErrorMsg"></p>
      </div>
      <table class="table table-bordered">
        <thead>
        <tr>
          <th class="px-0 py-0">#</th>
          <th class="px-0 py-0">Id</th>
          <th class="px-0 py-0" style="width: 120px">${labels.sample}</th>
          <th class="px-0 py-0" style="width: 210px">${labels.filtration_type}</th>
          <th class="px-0 py-0" style="width: 220px">${labels.start_datetime} (yyyy-mm-dd HH:MM:SS)</th>
          <th class="px-0 py-0" style="width: 110px">${labels.duration_min}</th>
          <th class="px-0 py-0" style="width: 110px">${labels.filtration_volume_ml}</th>
          <th class="px-0 py-0" style="width: 175px">${labels.storage_location}</th>
          <th class="px-0 py-0">${labels.comments}</th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="(f, index) in filters" :class="{'red-font':f.dirty}">
          <td class="px-0 py-0 text-muted">${index+1}</td>
          <td class="px-0  py-0 text-muted">${f.id}</td>
          <td class="px-0 py-0">
            <select v-model="f.sample" class="no-borders" @change="updateFilter(f)">
              <option value="">{% trans "Blank" %}</option>
              <option v-for="(obj, index) in sampleChoices" :value="obj.value">${obj.text}</option>
            </select>
          </td>
          <td class="px-0 py-0">
            <select v-model="f.filtration_type" class="no-borders" @change="updateFilter(f)">
              <option v-for="(obj, index) in filtrationTypeChoices" :value="obj.value">${obj.text}</option>
            </select>
          </td>
          <td class="px-0 py-0">
            <input type="text" class="no-borders" v-model="f.start_datetime" @change="updateFilter(f)">
          </td>
          <td class="px-0 py-0">
            <input type="text" class="no-borders" v-model="f.duration_min" @change="updateFilter(f)">
          </td>
          <td class="px-0 py-0">
            <input type="text" class="no-borders" v-model="f.filtration_volume_ml" @change="updateFilter(f)">
          </td>
          <td class="px-0 py-0">
            <input type="text" class="no-borders" v-model="f.storage_location" @change="updateFilter(f)">
          </td>
          <td class="px-0 py-0">
            <input type="text" class="no-borders" v-model="f.comments" @change="updateFilter(f)">
          </td>
          <td class="px-0 py-0">
            <button class="btn py-0" @click="deleteFilter(f)"><span class="h5 mdi mdi-delete"></span></button>
          </td>
        </tr>
        </tbody>
      </table>

    </div>

  </div>

{% endblock %}

{% block body_js %}

  {{ block.super }}
  <script type="application/javascript">
  let filterBatchId = {{ object.id }};
  var app = new Vue({
    el: '#app',
    delimiters: ["${", "}"],
    data: {
      loading: false,
      currentUser: null,
      labels: [],
      filtrationTypeChoices: [],
      sampleChoices: [],
      filters: [],
      filterErrorMsg: null
    },
    methods: {
      getCurrentUser() {
        let endpoint = `/api/edna/user/`;
        apiService(endpoint)
            .then(response => {
              this.currentUser = response;
            })
      },
      getFilterMetadata() {
        let endpoint = `/api/edna/meta/models/filter/`;
        apiService(endpoint).then(data => {
          this.labels = data.labels;
          this.filtrationTypeChoices = data.filtration_type_choices;
          this.sampleChoices = data.sample_choices;
        });
      },
      getFilters() {
        this.loading = true;
        endpoint = `/api/edna/filters/?batch=${filterBatchId}`;
        apiService(endpoint)
            .then(response => {
              this.loading = false;
              if (response.length && response[0].id) {
                for (var i = 0; i < response.length; i++) {
                  response[i].start_datetime = response[i].start_datetime.replace("T", " ").replace("Z", "")
                }
                this.filters = response;
              }
            })
      },
      getBlankFilter(sample) {
        let now = new Date(Date.now());
        if (!sample) {
          sample = this.getQueuedSamples(1)[0];
        }
        return {
          filtration_batch: filterBatchId,
          sample: sample,
          filtration_type: 1,
          start_datetime: `${now.getFullYear()}-${now.getMonth()}-${now.getDay()} ${now.getHours()}:${now.getMinutes()}`,
          duration_min: null,
          filtration_volume_ml: null,
          storage_location: null,
          comments: null,
        }
      },
      addFilter(howMany) {
        if (!howMany) {
          howMany = Number(prompt("{% trans 'How many filters do you want to add?' %}"));
        } else if (howMany === "all") {
          howMany = 0;
          for (var i = 0; i < this.sampleChoices.length; i++) {
            if (!this.sampleChoices[i].has_filter) {
              howMany += 1;
            }
          }
        }
        if (howMany) {
          sampleArray = this.getQueuedSamples(howMany);
          for (let i = 0; i < sampleArray.length; i++) {
            this.newFilter(sampleArray[i]);
          }
        }
      },
      newFilter(sample) {
        endpoint = `/api/edna/filters/`;
        data = this.getBlankFilter(sample)
        apiService(endpoint, "POST", data)
            .then(response => {
              if (response.id) {
                this.filters.push(response)
                // refresh the sample choices
                this.getFilterMetadata();
              }
            })
      },
      updateFilter(filter) {
        this.filterErrorMsg = null;
        endpoint = `/api/edna/filters/${filter.id}/`;
        apiService(endpoint, "PUT", filter)
            .then(response => {
              console.log(response)
              if (!response.id) {
                this.filterErrorMsg = this.groomJSON(response)
              }
            })
      },
      groomJSON(json) {
        return JSON.stringify(json).replaceAll("{", "").replaceAll("}", "").replaceAll("[", " ").replaceAll("]", " ").replaceAll('"', "").replaceAll("non_field_errors:", "")
      },
      getQueuedSamples(howMany) {
        let samples = [...this.sampleChoices];
        console.log(samples)
        myArray = []
        let result;
        for (let i = 0; i < howMany; i++) {
          result = "";
          for (let j = 0; j < samples.length; j++) {
            let sample = samples[j];
            if (!sample.has_filter) {
              let index = samples.indexOf(sample);
              result = samples.splice(index, 1)[0].value;
              break;
            }
          }
          myArray.push(result);
        }
        // return the results array
        return myArray;
      },
      deleteFilter(filter) {
        userInput = confirm("{% trans 'Are you sure you want to delete this filter?' %}");
        if (userInput) {
          let endpoint = `/api/edna/filters/${filter.id}/`;
          apiService(endpoint, "DELETE")
              .then(response => {
                this.$delete(this.filters, this.filters.indexOf(filter))
              })
        }
      },
    },
    computed
  :
  {
  }
  ,
  created()
  {
    this.getCurrentUser();
    this.getFilterMetadata();
    this.getFilters();
  }
  ,
  mounted()
  {
  }
  ,
  })
  ;
  </script>

{% endblock %}