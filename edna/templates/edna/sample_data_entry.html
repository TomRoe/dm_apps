{% extends 'edna/base.html' %}
{% load verbose_names %}
{% load i18n %}

{% block subcontent %}

  <div class="btns mb-3">
    <a href="{% url 'edna:collection_detail' object.id %}" class="btn btn-success btn-sm">{% trans "Back" %}</a>

  </div>

  <table class="table table-sm">
    {% for field in field_list %}
      {% verbose_td_display object field th_width="200px" %}
    {% endfor %}
  </table>

  <div id="app" class="mt-5">
    <div class="mb-3">
      <p class="h3">{% trans "Samples" %}</p>
      <button @click="addSample(null)" class="btn btn-sm btn-primary">{% trans "Add a Sample" %}</button>
    </div>

    <div class="row mb-3 px-1 py-1 w-25">
      <div class="col">
        <label for="">{% trans "Default sample type" %}</label>
        <select v-model="default_sample_type" class="form-control form-control-sm">
          <option :value="null">-----</option>
          <option v-for="(obj, index) in sampleTypeChoices" :value="obj.value">${obj.text}</option>
        </select>
      </div>
      {#      <div class="col">#}
      {#        <label for="">{% trans "Default filtration volume (ml)" %}</label>#}
      {#        <input type="text" class="form-control form-control-sm" v-model="default_filtration_volume_ml">#}
      {#      </div>#}
    </div>

    <div v-if="loading" class="loading mb-3 mt-3 mt-5">
      <div class="spinner-border mb-3" style="width: 5rem; height: 5rem;" role="status">
        <span class="sr-only"></span>
      </div>
    </div>
    <div v-else-if="!samples.length">
      <em>{% trans "No samples have been added to this collection." %}</em>
    </div>
    <div v-else>
      <div class="alert alert-danger" role="alert" v-if="sampleErrorMsg">
        <p class="mb-0 lead" v-html="sampleErrorMsg"></p>
      </div>
      <table :class="{'unsaved-borders':unsavedChanges, 'saved-borders':!unsavedChanges}" style="width: 100%">
        <thead>
        <tr>
          <th class="px-1 py-1" style="width: 75px">{% trans "Sample ID" %}</th>
          <th class="px-1 py-1" style="width: 125px">${labels.sample_type}</th>
          <th class="px-1 py-1" style="width: 100px">${labels.bottle_id}</th>
          <th class="px-1 py-1" style="width: 150px">${labels.location}</th>
          <th class="px-1 py-1" style="width: 100px">${labels.site}</th>
          <th class="px-1 py-1" style="width: 100px">${labels.station}</th>
          <th class="px-1 py-1" style="width: 220px">${labels.datetime} <br>(yyyy-mm-dd HH:MM:SS)</th>
          <th class="px-1 py-1" style="width: 200px">${labels.samplers}</th>
          <th class="px-1 py-1" style="width: 100px">${labels.latitude}</th>
          <th class="px-1 py-1" style="width: 100px">${labels.longitude}</th>
          <th class="px-1 py-1">${labels.comments}</th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="(f, index) in samples" :key="f.id">
          <td class="px-1  py-0 text-muted" tabindex="-1">${f.display}</td>
          <td class="px-0 py-0">
            <select v-model="f.sample_type" class="no-borders" @change="updateSample(f)">
              <option value="">{% trans "-----" %}</option>
              <option v-for="(obj, index) in sampleTypeChoices" :value="obj.value">${obj.text}</option>
            </select>
          </td>

          <td class="px-0 py-0">
            <input type="text" class="no-borders" v-model="f.bottle_id" @change="updateSample(f)" @keypress="unsavedChanges=true">
          </td>
          <td class="px-0 py-0">
            <input type="text" class="no-borders" v-model="f.location" @change="updateSample(f)" @keypress="unsavedChanges=true">
          </td>
          <td class="px-0 py-0">
            <input type="text" class="no-borders" v-model="f.site" @change="updateSample(f)" @keypress="unsavedChanges=true">
          </td>
          <td class="px-0 py-0">
            <input type="text" class="no-borders" v-model="f.station" @change="updateSample(f)" @keypress="unsavedChanges=true">
          </td>
          <td class="px-0 py-0">
            <input type="datetime-local" class="no-borders" v-model="f.datetime_display" @change="updateSample(f)" @keypress="unsavedChanges=true">
          </td>
          <td class="px-0 py-0">
            <input type="text" class="no-borders" v-model="f.samplers" @change="updateSample(f)" @keypress="unsavedChanges=true">
          </td>
          <td class="px-0 py-0">
            <input type="number" step="any" class="no-borders" v-model="f.latitude" @change="updateSample(f)" @keypress="unsavedChanges=true">
          </td>
          <td class="px-0 py-0">
            <input type="number" step="any" class="no-borders" v-model="f.longitude" @change="updateSample(f)" @keypress="unsavedChanges=true">
          </td>
          <td class="px-0 py-0">
            <input type="text" class="no-borders" v-model="f.comments" @change="updateSample(f)" @keypress="unsavedChanges=true">
          </td>
          <td class="px-0 py-0">
            <button class="btn py-0" @click="deleteSample(f)"><span class="h5 mdi mdi-delete"></span></button>
          </td>
        </tr>
        </tbody>
      </table>

    </div>

  </div>

{% endblock %}

{% block body_js %}

</script>
  {{ block.super }}
  <script type="application/javascript">
  let collectionId = {{ object.id }};
  var app = new Vue({
    el: '#app',
    delimiters: ["${", "}"],
    data: {
      currentUser: null,
      default_sample_type: null,
      sampleErrorMsg: null,
      samples: [],
      sampleTypeChoices: [],
      labels: [],
      loading: false,
      sampleChoices: [],
      unsavedChanges: false

    },
    methods: {
      addSample(howMany) {
        if (!howMany) howMany = Number(prompt("{% trans 'How many samples do you want to add?' %}"));
        if (howMany) {
          for (let i = 0; i < howMany; i++) {
            this.newSample();
          }
        }
      },
      deleteSample(sample) {
        userInput = confirm("{% trans 'Are you sure you want to delete this sample?' %}");
        if (userInput) {
          let endpoint = `/api/edna/samples/${sample.id}/`;
          apiService(endpoint, "DELETE")
              .then(response => {
                this.$delete(this.samples, this.samples.indexOf(sample))
              })
        }
      },
      getBlankSample(sample) {
        //let now = new Date(Date.now());
        return {
          collection: collectionId,
          sample_type: this.default_sample_type,
        }
      },
      getCurrentUser() {
        let endpoint = `/api/edna/user/`;
        apiService(endpoint)
            .then(response => {
              this.currentUser = response;
            })
      },
      getSampleMetadata() {
        let endpoint = `/api/edna/meta/models/sample/`;
        apiService(endpoint).then(data => {
          this.labels = data.labels;
          this.sampleTypeChoices = data.sample_type_choices;
          {#this.sampleChoices = data.sample_choices;#}
        });
      },
      getSamples() {
        this.loading = true;
        endpoint = `/api/edna/samples/?collection=${collectionId}`;
        apiService(endpoint)
            .then(response => {
              this.loading = false;
              if (response.length && response[0].id) {
                for (var i = 0; i < response.length; i++) {
                  //response[i].datetime = response[i].datetime.replace("T", " ").replace("Z", "")
                  //if (!response[i].sample) response[i].sample = "";

                }
                this.samples = response;
              }
            })
      },
      newSample(sample) {
        endpoint = `/api/edna/samples/`;
        data = this.getBlankSample(sample)
        apiService(endpoint, "POST", data)
            .then(response => {
              if (response.id) {
                this.samples.push(response)
              } else {
                console.log(response)
              }
            })
      },
      updateSample(sample) {
        this.sampleErrorMsg = null;
        endpoint = `/api/edna/samples/${sample.id}/`;
        sample.datetime = sample.datetime_display
        if (sample.bottle_id === "") sample.bottle_id = null;
        sample.datetime = sample.datetime_display
        apiService(endpoint, "PUT", sample)
            .then(response => {
              if (!response.id) this.sampleErrorMsg = groomJSON(response);
              else this.unsavedChanges = false;
            })
      },
    },
    created() {
      this.getCurrentUser();
      this.getSampleMetadata();
      this.getSamples();
    },
  });
  </script>

{% endblock %}