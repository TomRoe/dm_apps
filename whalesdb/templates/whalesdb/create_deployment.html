{% extends "whalesdb/whale_base.html" %}
{% load bootstrap4 %}
{% load static %}
{% load i18n %}
{% bootstrap_css %}
{% load verbose_names %}

{% block title %}
    {% trans "Deployment" %}
{% endblock %}

{% block body %}
<div class="container-fluid">
    <form method="post" class="form">
        {% csrf_token %}

        {% for field in form %}
            <div class="row">
                <div class="col-6">
                {% bootstrap_field field placeholder="" size="small" %}
                </div>
                {% with field.label|add:" " as btn_txt %}
                {% if field.name == 'stn' or field.name == 'prj' or field.name == 'mor' %}
                <div class="col-3 align-bottom">
                    <br />
                    {% with "New "|add:btn_txt as btn_lbl %}
                    <a href="#" class="btn btn-primary" onclick="return popitup('{% url 'whalesdb:create_obj' 'pop' field.name %}','popoutWindow')">{% trans btn_lbl %}</a>
                    {% endwith %}
                </div>
                {% endif %}
                {% endwith %}
            </div>
        {% endfor %}

        {% buttons %}
            <button type="submit" class="btn btn-success" onclick="refreshParent()">
                {% trans "Submit" %}
            </button>
            {% if pop %}
                <a class="btn btn-secondary" onclick="window.close()" href="">
                    {% trans "Close" %}
                </a>
             {% else %}
                {% if obj_name %}
                <a class="btn btn-secondary" href="{% url cancel_url obj_name %}">
                {% else %}
                <a class="btn btn-secondary" href="{% url cancel_url %}">
                {% endif %}
                    {% trans "Cancel" %}
                </a>
             {% endif %}
        {% endbuttons %}
    </form>
</div>
{% endblock body %}

{% block body_js %}
<script type="application/javascript">
    stnObj = {{ station_json|safe }};

    $("#id_dep_year").change(function (e) {
        setName()
    })

    $("#id_dep_month").change(function (e) {
        setName()
    })

    $("#id_stn").change(function (e) {
        setName()
    })

    function setName() {
        year = $("#id_dep_year").val()
        month = $("#id_dep_month").val()
        stn = $("#id_stn").val()
        stn_code = ""

        for (var i = 0; i < Object.keys(stnObj).length; i++) {
            var key = Object.keys(stnObj)[i];
            if( stn == stnObj[key].stn_id ) {
                stn_code = stnObj[key].stn_code
                break;
            }
        }

        name = ""
        if( stn_code != "" ) {
            name = stn_code;
        }
        if( year != "" ) {
            if(name != "") {
                name += "-";
            }
            name += year
        }
        if( month != null ) {
            if( name != "" ) {
                name += "-";
            }
            name += month.padStart(2, '0');
        }

        $("#id_dep_name").val(name);
    }
</script>
{% endblock body_js %}