{% extends 'grais/base.html' %}
{% load i18n %}

{% block subcontent %}
  <div id="app">
    <div class="alert alert-danger" role="alert" v-if="obsErrorMsg">
      <p class="mb-0 lead" v-html="obsErrorMsg"></p>
    </div>
    <div v-if="!observations.length">
      <em>There are no species observations</em>
    </div>
    <div v-else>
      <table :class="{'unsaved-borders':unsavedChanges, 'saved-borders':!unsavedChanges}" style="width: 100%">
        <thead>
        <tr>
          <th class="px-1 py-1" style="width: 25px">#</th>
          <th>Species</th>
          <th style="width: 250px;">Observation Date</th>
          <th>Notes</th>
          {#        <th style="width: 25px">Id</th>#}
        </tr>
        </thead>
        <tbody>
        <tr v-for="(obs, index) in observations" :key="index">
          <td class="px-0 py-0 text-muted" tabindex="-1">${index+1}</td>
          <td class="px-0 py-0">
            {#          <v-select v-model="obs.species" :items="speciesChoices" required class="no-borders"></v-select>#}
            <select v-model="obs.species" class="no-borders" @change="updateObservation(obs)">
              <option value="">{% trans "-----" %}</option>
              <option v-for="(obj, index) in speciesChoices" :value="obj.value">${obj.text}</option>
            </select>
          </td>
          <td class="px-0 py-0">
            <input type="datetime-local" class="no-borders" v-model="obs.observation_date" @change="updateObservation(obs)" @keypress="unsavedChanges=true">
          </td>
          <td class="px-0 py-0">
            <input type="text" class="no-borders" v-model="obs.notes" @change="updateObservation(obs)" @keypress="unsavedChanges=true">
          </td>
          {#        <td>          <span class="text-muted">${obs.id} </span>        </td>#}
          <td class="px-0 py-0">
            <button class="btn py-0 px-0" @click="deleteObservation(obs)"><span class="h5 mdi mdi-delete"></span></button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
    <button @click="addObservation" class="btn btn-sm btn-primary py-0 mt-3">Add</button>

  </div>
{% endblock %}

{% block body_js %}
  {{ block.super }}
  <script type="application/javascript">
  // bring in from django
  let pageType = "{{ view.kwargs.type }}";
  let objectId = {{ object.id }};

  // register vue-select
  Vue.component('v-select', VueSelect.VueSelect);

  // vuejs instance
  var app = new Vue({
    el: '#app',
    delimiters: ["${", "}"],
    data: {
      currentUser: null,
      loadingObservations: false,
      observations: [],
      speciesChoices: [],
      speciesLabels: [],
      unsavedChanges: false,
      obsErrorMsg: null,
    },
    methods: {
      addObservation() {
        this.unsavedChanges = true;
        let dt = "";
        if (this.observations.length && this.observations[this.observations.length - 1].observation_date) dt = this.observations[this.observations.length - 1].observation_date;
        obj = {
          species: "",
          observation_date: dt,
          notes: "",
        }
        if (pageType === "samples") obj.sample = objectId;
        else if (pageType === "lines") obj.line = objectId;
        this.observations.push(obj);
      },

      getSpeciesMetadata() {
        let endpoint = `/api/grais/meta/models/species/`;
        apiService(endpoint).then(data => {
          this.speciesLabels = data.labels;
          this.speciesChoices = data.choices;
        });
      },

      getCurrentUser() {
        let endpoint = `/api/grais/user/`;
        apiService(endpoint)
            .then(response => {
              this.currentUser = response;
              this.isAdminOrMgmt = this.currentUser.is_admin || this.currentUser.is_management
            })
      },
      getObservations() {
        this.loadingObservations = true;
        let endpoint;
        if (pageType === "samples") endpoint = `${this.endpointPrefix}/?sample=${objectId}`;
        else if (pageType === "lines") endpoint = `${this.endpointPrefix}/?line=${objectId}`;
        apiService(endpoint)
            .then(response => {
              if (response.length && response[0].id) {
                for (var i = 0; i < response.length; i++) {
                  response[i].observation_date = response[i].observation_date.replace("Z", "")
                }
                this.observations = response;
                this.loadingObservations = false;
              }
            })
      },
      updateObservation(obs) {
        this.unsavedChanges = true;
        this.obsErrorMsg = null;
        let endpoint;
        let method;
        if (obs.id) {
          endpoint = `${this.endpointPrefix}/${obs.id}/`;
          method = "PUT";
        } else {
          endpoint = `${this.endpointPrefix}/`;
          method = "POST";
        }
        apiService(endpoint, method, obs)
            .then(response => {
              if (!response.id) this.obsErrorMsg = this.groomJSON(response);
              else {
                response.observation_date = response.observation_date.replace("Z", "")
                this.$set(this.observations, this.observations.indexOf(obs), response)
                this.unsavedChanges = false;
              }
            })
      },
      deleteObservation(obs) {
        userInput = confirm("{% trans 'Are you sure you want to delete this observation?' %}");
        if (userInput) {
          if (obs.id) {
            let endpoint = `${this.endpointPrefix}/${obs.id}/`;
            apiService(endpoint, "DELETE")
                .then(response => {
                  this.$delete(this.observations, this.observations.indexOf(obs));
                })
          } else {
            this.$delete(this.observations, this.observations.indexOf(obs));
            this.unsavedChanges = false;
          }
        }
      },
      groomJSON(json) {
        return JSON.stringify(json).replaceAll("{", "").replaceAll("}", "").replaceAll("[", " ").replaceAll("]", " ").replaceAll('"', "").replaceAll("non_field_errors:", "")
      },

    },
    computed: {
      endpointPrefix() {
        return `/api/grais/${pageType.slice(0, pageType.length - 1)}-species`
      }
    },
    created() {
      this.getObservations();
      this.getSpeciesMetadata();
    },
  });


  </script>

{% endblock %}
