{% extends "snowcrab/snowcrab_base.html" %}
{% load bootstrap4 %}
{% load verbose_names %}
{% load static %}

{% block content %}

    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'crab:index' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'crab:cruise_list' %}">Cruises</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{object}}</li>
        </ol>
    </nav>

    <style>
        /* Set the size of the div element that contains the map */
        #map, #lineMap {
            height: 500px; /* The height is 400 pixels */
            width: 100%; /* The width is the width of the web page */
        }

        .label {
            font-weight: bold;
        }
    </style>
    <div class="indent-med">
        <h1>{{ object.mission_number }}</h1>
        <div class="btn-group">
            {% if user.is_superuser %}
                <a href="{% url "crab:cruise_edit" object.id %}" class="btn btn-warning">Edit</a>
            {% else %}
                <a href="{% url "crab:cruise_edit" object.id %}" class="btn btn-warning disabled">Edit</a>

            {% endif %}

            {#            <a href="{% url "crab:bottle_list" object.id %}" class="btn btn-primary">View Bottles</a>#}
            {#            <a href="{% url "oceanography:mission_export_csv" object.id %}" class="btn btn-success">Export Bottle#}
            {#                CSV</a>#}
            {#            <a href="{% url "oceanography:file_create" object.id %}" class="btn btn-info">Add a File</a>#}
            {#            <a href="{% url "oceanography:mission_list" object.season %}" class="btn btn-dark">Back</a>#}
        </div>
        <br><br>

        <div class="row">
            <div class="col-4">
                {% for field in field_list %}
                    {% verbose_field_display object field %}
                {% endfor %}
            </div>

            <div class="col">

                <b>Set Map:</b>

                <div id="map"></div>
            </div>
        </div>
        <div class="row">
            <br><br>
            <h3>Set List:</h3>
            {% include "snowcrab/_set_list.html" %}
        </div>
    </div>

    <script>
        function initialize() {
            var locations = [

                {% for set in object.sets.all %}
                    {% if set.latitude_start_logbook and set.longitude_start_logbook and set.valid %}
                        ['<a href="{% url 'crab:set_detail' set.id %}">Set {{set.set_name}}</a>', {{set.latitude_start_logbook}}, {{set.longitude_start_logbook}}, '{% static "/img/icons/boat.png" %}'],
                    {% endif %}
                {% endfor %}
            ];
            window.map = new google.maps.Map(document.getElementById('map'), {
                mapTypeId: google.maps.MapTypeId.SATELLITE
            });

            var infowindow = new google.maps.InfoWindow();

            var bounds = new google.maps.LatLngBounds();

            for (i = 0; i < locations.length; i++) {
                marker = new google.maps.Marker({
                    position: new google.maps.LatLng(locations[i][1], locations[i][2]),
                    map: map,
                    icon: locations[i][3],
                });

                bounds.extend(marker.position);
                {#uncomment this if you don't want the markers#}
                {#bounds.extend(new google.maps.LatLng(locations[i][1], locations[i][2]));#}



                google.maps.event.addListener(marker, 'click', (function (marker, i) {
                    return function () {
                        infowindow.setContent(locations[i][0]);
                        infowindow.open(map, marker);
                    }
                })(marker, i));
            }

            map.fitBounds(bounds);

            var flightPlanCoordinates = [
                {% for set in object.sets.all %}
                    {% if set.latitude_start_logbook and set.longitude_start_logbook and set.valid %}
                        {lat: {{set.latitude_start_logbook}}, lng: {{set.longitude_start_logbook}}},
                    {% endif %}
                {% endfor %}
            ];

            var flightPath = new google.maps.Polyline({
                path: flightPlanCoordinates,
                geodesic: true,
                strokeColor: '#fe0207',
                strokeOpacity: 1.0,
                strokeWeight: 2
            });

            flightPath.setMap(map);
        }

        function loadScript() {
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = "https://maps.googleapis.com/maps/api/js?key={{google_api_key}}&callback=initialize";
            document.body.appendChild(script);
        }

        window.onload = loadScript;

    </script>

{% endblock content %}
