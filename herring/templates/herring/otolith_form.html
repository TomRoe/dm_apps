{% extends "herring/herring_base.html" %}

{% load bootstrap4 %}
{% load verbose_names %}
{% load percentage %}
{% load divide %}
{% load static %}

{% block content %}
<div class="nav-map">
<br>
  <p>
    <a href="{% url 'herring:sample_list' %}">All Samples</a> >
    <a id="home" href="{% url 'herring:port_sample_detail' object.sample.id %}">Sample {{object.sample.id}}</a> >
    Fish {{object.id}}
  </p>
</div>

{# <embed src="{% static "/sounds/success.wav" %}" autostart="false" width="0" height="0" id="sound1" enablejavascript="true"> #}

<style media="screen">
  .indent-med{
    font-size: .9em;
  }
  label{
    font-weight: bold;
  }
</style>

<div class="indent-med">

  <h1>
    Fish #{{object.fish_number}}
  </h1>

  <br>

  <div class="row">
    <div class="col-5">
      {% include "herring/_lab_sample_metadata.html" %}

      <h4>Otolith Detail:</h4>
      <div class="btn-group ">
      </div>
      <form method="post">
        {% csrf_token %}

        {% for field in form %}
          {%bootstrap_field field layout='horizontal' placeholder=""%}

        {% endfor %}
        {# <input type="submit" name="" value="Save" class="btn btn-primary"> #}


        <br>

        <input type="submit" class="btn btn-warning gone" value="Validate" id="validate">
        {% if next_fish_id %}
        <a id="next" class="btn btn-primary gone" href="#">Next</a>
        {% else %}
        <a id="next" class="btn btn-success gone" href="#">All Done!</a>
        {% endif %}
        <a class="btn btn-secondary" href="{% url 'herring:port_sample_detail' object.sample.id %}">Cancel</a>

      </form>
    </div>
    <div class="col-1">

    </div>
    <div class="col-5">
      {% include "herring/_otolith_qc.html" %}
      <br>
      <h4>Shortcuts:</h4>
      <table class="table table-sm table-bordered" style="width: 65%;">
        <thead>
          <th>Action</th>
          <th>Key</th>
        </thead>
        <tbody>
          <tr>
            <td>
              <a href="#" id="myBtn">Preview Fish Detail</a>
            </td>
            <td>F1</td>
          </tr>
          <tr>
            <td>Exit Preview Mode</td>
            <td>Esc</td>
          </tr>
          <tr>
            <td>Move to previous record (without saving)</td>
            <td>PageUp</td>
          </tr>
          <tr>
            <td>Move to next record (without saving)</td>
            <td>PageDown</td>
          </tr>
          <tr>
            <td>Back to sample detail page</td>
            <td>Home</td>
          </tr>
        </tbody>
      </table>


    </div>
  </div>
<div class="row">
</div>
</div>


<!-- The Modal -->
<!-- Modal content -->
<div id="myModal" class="modal">
  <div class="modal-content">

    <p>
      <span class="label">Fish lenth:</span>
      <span class="value">{{object.fish_length}} mm</span> <br>

      <span class="label">Fish weight:</span>
      <span class="value">{{object.fish_weight}} g</span> <br>

      <span class="label">Sex:</span>
      <span class="value">{{object.sex}}</span> <br>

      <span class="label">Maturity:</span>
      <span class="value">{{object.maturity}}</span> <br>

      <span class="label">Gonad weight:</span>
      <span class="value">{{object.gonad_weight}} g</span> <br>
    </p>

    <div class="container">

      <a href="#" class="btn btn-lg btn-primary float-center closeBtn">Close (Esc)</a>
      {# <a href="{% url 'inventory:send_certification_email' object.user_id %}" class="btn btn-lg btn-warning float-center">Send Away!</a> #}
    </div>
  </div>

</div>




<script type="text/javascript">
  // var keepPrompting = true;
  var clickSubmit = false;
  var progress = {{progress}};
  var totalTests = {{total_tests}};
  {% if test_200 %}
    var test200Passed = true;
  {% else %}
    var test200Passed = false;
  {% endif %}
  var qcFeedbackLookup = '{{qc_feedback_json|safe}}';
  var qcFeedbackObject = JSON.parse(qcFeedbackLookup);

  var nextPageHref = "{% url "herring:move_record" object.sample.id "otolith" "next" object.id %}";
  var prevPageHref = "{% url "herring:move_record" object.sample.id "otolith" "prev" object.id %}";
  var nextFishy = "{{next_fish_id}}"



  $(document).ready(function () {
    improbableMeasurementValidation()
    // if the otolith detail is complete, just show the next btn; otherwise must validate first
    if (test200Passed) {
      $("#next").removeClass("gone")
      $("#next").focus();
    }
    else {
      $("#validate").removeClass("gone")
      $("#id_annulus_count").focus();
    }


  })


  $("#next").click(function () {
    if (nextFishy == "") {
      $("#home")[0].click()
    }
    else {
      document.location.href = nextPageHref;
    }
  })

  $(document).keydown(function(event){
      if ( event.key == 'PageDown' ) {
        event.preventDefault()
        document.location.href = nextPageHref;
      }
      else if ( event.key == 'PageUp' ) {
        event.preventDefault()
        document.location.href = prevPageHref;
      }
      else if ( event.key == 'F1' ) {
        event.preventDefault()
        $("#myBtn")[0].click();
      }
      else if ( event.key == 'Escape' ) {
        event.preventDefault()
        $(".closeBtn")[0].click();
      }
      else if ( event.key == 'Home' ) {
        $("#home")[0].click()
      }
    })

    $("#submit-next").click(function () {
      $("form").submit()
      improbableMeasurementValidation()
      // document.location.href = nextPageHref
    })


  function improbableMeasurementValidation() {
    var userInput
    // JSON atributes to check
    check_list = ["annulus_count", "global_209"]

    for (var i = 0; i < check_list.length; i++) {
      if (jQuery.isEmptyObject(qcFeedbackObject[check_list[i]]) == false) {
        // means there is a problem that needs dealing with

        while (userInput != "y" && userInput != "n") {
          userInput = prompt(qcFeedbackObject[check_list[i]].msg)
        }
        if (userInput == 'y') {
          // if user is confident, we will communicate this back to the server and mark yes for accepted
          $("#id_improbable_field").val(check_list[i]);
          $("#id_improbable_test").val(qcFeedbackObject[check_list[i]].test);
          $("#id_improbable_accepted").val(1);
          $("form").submit()
        }
        break
      }
    }
  }



</script>


{% endblock content %}
