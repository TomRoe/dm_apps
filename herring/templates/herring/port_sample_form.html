{% extends "herring/herring_base.html" %}

{% load bootstrap4 %}

{% block content %}
<div class="nav-map">
<br>
  {% if object.id %}
  <p>
    <a href="{% url 'herring:sample_list' %}">All samples</a> >
    <a href="{% url 'herring:port_sample_detail' object.id %}">Sample {{object.id}}</a> >
    Edit
  </p>
  {% else %}
  <p>
    <a href="{% url 'herring:index' %}">Home</a> >
    New Port Sample
  </p>
  {% endif %}
</div>
<div class="container">

  {% load static %}
  {# Load js file to allow for popout window #}
  {% if object.id %}
    <h1>Port Sample {{object.id}}</h1><br>
  {% else %}
    <h1>New Port Sample</h1>
  {% endif %}

  <form method="post" class="form">
    {%bootstrap_form_errors form%}
      {% csrf_token %}
      <br>
      <div class="row">
        <div class="col-8">
          <table>
            {% for field in form  %}
            <tr>
              <td width='80%'>
              {% if field.name == "district" %}
                <div id="district_interpreter_div">
                  <div class="form-group row" style="margin-bottom: 0px;">
                    <label for="district_interpreter" class="col-md-3 col-form-label">District (any part of name or code)</label>
                    <div class="col-md-9">
                      <input type="text" class="form-control tab" id="district_interpreter">
                    </div>
                  </div>
                  <div class="form-group row" style="margin-bottom: 0px;">
                    <label for="district_list" class="col-md-3 col-form-label"></label>
                    <div class="col-md-9">
                      <p id="district_list"></p>
                    </div>
                  </div>
                </div>

                <div id="district_field_div">
                  {% bootstrap_field field size='small' layout='horizontal' placeholder=""%}
                  <div class="form-group row" style="margin-top: 0px;">
                    <label for="clear_district" class="col-md-3 col-form-label"></label>
                    <div class="col-md-9">
                      <a href="#" id="clear_district" class="red-font">(clear district)</a>
                    </div>
                  </div>
                </div>

                {% elif field.name == "sampler" %}
                  <div id="sampler_interpreter_div">
                    <div class="form-group row" style="margin-bottom: 0px;">
                      <label for="sampler_interpreter" class="col-md-3 col-form-label">Sampler (any part of name)</label>
                      <div class="col-md-9">
                        <input type="text" class="form-control tab" id="sampler_interpreter">
                      </div>
                    </div>
                    <div class="form-group row" style="margin-bottom: 0px;">
                      <label for="sampler_list" class="col-md-3 col-form-label"></label>
                      <div class="col-md-9">
                        <p id="sampler_list" style="margin-bottom: 0px;"></p>
                        <a href="#" id="add_sampler">(add new sampler)</a>
                      </div>
                    </div>
                  </div>

                  <div id="sampler_field_div">
                    {% bootstrap_field field size='small' layout='horizontal' placeholder=""%}
                    <div class="form-group row" style="margin-top: 0px;">
                      <label for="clear_sampler" class="col-md-3 col-form-label"></label>
                      <div class="col-md-9">
                        <a href="#" id="clear_sampler" class="red-font">(clear sampler)</a>
                      </div>
                    </div>
                  </div>


                {% else %}

                {% bootstrap_field field size='small' layout='horizontal' placeholder=""%}
              {% endif %}
              </td>

            </tr>

            {% endfor %}
          </table>

        </div>
      </div>

      <p>
        <button id="submit" type="submit" class="btn btn-primary">Submit</button>
        {% if object.id %}
          <a class="btn btn-secondary" href="#">Cancel</a>
        {% else %}
          <a class="btn btn-secondary" href="{% url 'herring:index' %}">Cancel</a>
        {% endif %}
      </p>
  </form>
</div>

<button  class="hidden" id="add_sampler_btn"></button>


<script type="text/javascript">
window.name = "motherWindow"
var position = 0;
var districtList = {{district_list|safe}}
var samplerList = {{sampler_list|safe}}

function assignIndexToElements(indexName, className) {
  for (var i = 0; i < $("."+className).length; i++) {
    $("."+className)[i].setAttribute(indexName,i)
  }
  // have this variable called position that will always have the index of the focused element
  $("."+className).focus(function () {
    position = Number(this.getAttribute(indexName))
  })
}


function startFocusOnElement(targetId) {
  $(document).ready(function() {
    $("#"+ targetId )[0].focus()
  });
}

function disableKey(keyName) {
  $(document).keydown(function(event){
    if ( event.key == keyName ) {
      event.preventDefault()
    }
  });
}


function enterKey(className, submitButtonId) {
  $(document).keydown(function(event){

    // determine how many fields there are
    var maxCount = $("."+className).length;
    if ( event.key == 'Enter' ) {
      event.preventDefault()
      // DESIRED BEHAVIOUR:
      // if you press enter, it will act as down arrow, unless you are on the last field, at which point
      // it will act as a submit button

      // if we are on the last button
      if (position == maxCount-1) {
        $("#"+submitButtonId)[0].click()
      }
      // else, jump to the next record
      else {
        $("."+className)[position+1].focus();
      }
    }
  });
}

  $("#add_sampler").click(function () {
    // document.location.href = "{% url "herring:sampler_new_pop" %}"
    popitup('{% url 'herring:sampler_new_pop' %}','popoutWindow0')
  })

  assignIndexToElements("index", "tab")
  startFocusOnElement("id_sample_date")
  // disableKey("Tab")
  enterKey("tab", "submit" )

  $(document).ready(function() {

    {% if object.district %}
      $("#district_interpreter_div").prop("hidden",true)
    {% else %}
      $("#district_field_div").prop("hidden",true)
    {% endif %}

    {% if object.sampler %}
      $("#sampler_interpreter_div").prop("hidden",true)
      $("#add_sampler").prop("hidden",true)
    {% else %}
      $("#sampler_field_div").prop("hidden",true)
      $("#add_sampler").prop("hidden",true)
    {% endif %}

  });

  $("#district_interpreter").keyup(function(e) {
    $("#district_list").html("")
      if ( (this.value.length >=2 && this.value.match(/^\d+$/)) || this.value.length >=3 ) {
        for (var i = 0; i < districtList.length; i++) {
          // console.log(123);
          var re = new RegExp(this.value, 'gi');

          if (districtList[i].match(re)) {
            $("#district_list").html(
              $("#district_list").html() + districtList[i]+'<br>')
          }
        }



        $(".district_insert").click(function() {
          $("#district_field_div").prop("hidden",false)
          $("#district_interpreter_div").prop("hidden",true)
          code = this.getAttribute("code")
          $("#id_district").val(code)

          $("#id_latitude_n")[0].focus()

        });

      }
  });

  $("#sampler_interpreter").keyup(function(e) {
    $("#sampler_list").html("")
    $("#add_sampler").prop("hidden",true)
      if (this.value.length >=3 ) {
        $("#add_sampler").prop("hidden",false)
        for (var i = 0; i < samplerList.length; i++) {
          // console.log(123);
          var re = new RegExp(this.value, 'gi');

          if (samplerList[i].match(re)) {
            $("#sampler_list").html(
              $("#sampler_list").html() + samplerList[i]+'<br>')
          }
        }



        $(".sampler_insert").click(function() {
          $("#sampler_field_div").prop("hidden",false)
          $("#sampler_interpreter_div").prop("hidden",true)
          code = this.getAttribute("code")
          $("#id_sampler").val(code)

          $("#district_interpreter")[0].focus()

        });

      }
  });




  $("#clear_district").click(function() {
    $("#district_interpreter").val("")
    $("#district_list").html("")
    $("#district_field_div").prop("hidden",true)
    $("#district_interpreter_div").prop("hidden",false)
    $("#district_interpreter")[0].focus()

  });


    $("#clear_sampler").click(function() {
      $("#sampler_interpreter").val("")
      $("#sampler_list").html("")
      $("#sampler_field_div").prop("hidden",true)
      $("#sampler_interpreter_div").prop("hidden",false)
      $("#sampler_interpreter")[0].focus()
      $("#add_sampler").prop("hidden",true)
    });

$("#add_sampler_btn").click(function () {
  $("#sampler_field_div").prop("hidden",false)
  $("#sampler_interpreter_div").prop("hidden",true)
  $("#district_interpreter")[0].focus()
})

</script>
{% endblock content %}
