{% load static %}
{% load i18n %}
{% load custom_filters %}
{% load travel_filters %}
{% load travel_tags %}
{% load verbose_names %}

<div class="card mb-2">
  <h3 class="card-header bg-outline-dark">
    <div class="float-right">
      <button @click="expandTravellers" data-toggle="tooltip" title="{% trans "Expand all" %}"><span class="mdi mdi-arrow-collapse-down"></span></button>
      <button @click="collapseTravellers" data-toggle="tooltip" title="{% trans "Collapse all" %}"><span class="mdi mdi-arrow-collapse-up"></span></button>
      <button v-if="!isReview && canModify && !travellerToEdit" @click="addTraveller" data-toggle="tooltip" title="{% trans "Add traveller" %}"
              class="btn btn-sm btn-primary ml-2">
        <span class="mdi mdi-plus text-light"></span> {% trans "Add traveller" %}
      </button>
    </div>
    {% trans "Travellers Associated with this Request" %}
    <span @mouseover="enablePopovers" class="mdi mdi-help-circle-outline" data-toggle="popover"
          data-trigger="hover" title="{% trans "Travellers" %}"
          :data-content="helpText.travellers_header"></span>
  </h3>
  <div class="card-body">
    <div class="card-text">
      <div v-if="loading" class="loading mb-3 mt-3 text-center mt-5">
        <div class="spinner-border mb-3" style="width: 10rem; height: 10rem;" role="status">
          <span class="sr-only"></span>
        </div>
      </div>
      <div v-else>
        <div v-if="travellers.length">
          <div v-if="!travellerToEdit">
            <div v-for="(t,index) in travellers" class="mx-1" :key="t.id">
              <div :class="{'card traveller-card mx-1':true, 'closed-traveller':!t.show_me}">
                <div class="card-body">
                  <div class="float-right">
                    <button v-if="!isReview && canModify && !trip && !t.show_me" @click="editTraveller(t)"><span class="mdi mdi-pencil h4"
                                                                                                   data-toggle="tooltip"
                                                                                                   title="{% trans "Edit" %}"></span></button>
                    <button v-if="!isReview && canModify && !trip && !t.show_me" @click="addTraveller(t)"><span class="mdi mdi-content-copy h4"
                                                                                                  data-toggle="tooltip" title="{% trans "Clone" %}"></span></button>
                    <button v-if="canModify && !t.show_me" @click="deleteTraveller(t)"><span class="mdi mdi-delete h4" data-toggle="tooltip"
                                                                               title="{% trans "Remove" %}"></span></button>
                    &nbsp; &nbsp; &nbsp;
                    <button @click="toggleShowMe(t)"
                            data-toggle="tooltip" title="{% trans "collapse" %}">
                      <span v-if="t.show_me" class="mdi mdi-arrow-collapse-up h4"></span>
                      <span v-else class="mdi mdi-arrow-collapse-down h4"></span>
                    </button>
                  </div>
                  <h5 class="card-title">
                    ${index+1}. ${t.smart_name} <span v-if="t.role"> (${t.role_display})</span>
                    <span v-if="t.is_research_scientist"> &mdash; {% trans "Research Scientist" %}</span>
                    <span v-else-if="!t.is_public_servant"> &mdash; {% trans "EXTERNAL" %}</span>
                  </h5>
                  <div v-if="t.show_me" class="card-text">
                    <div v-if="trip">
                      <hr>
                      <h4>{% trans "Request Level" %}</h4>
                      <p>
                        <b>{% trans "Associated trip request" %}</b>
                        <a :href="`/travel-plans/requests/${t.request_obj.id}/view/`" target="_blank">${t.request_obj.display}</a>
                      </p>
                      <p>
                        <b>${requestLabels.status}</b>
                        <span><span :class="t.request_obj.status_class + ' px-1 py-1'">${t.request_obj.status_display}</span></span>
                      </p>
                      <p>
                        <b>{% trans "DFO region" %}</b>
                        <span>${t.request_obj.region}</span>
                      </p>
                      <p>
                        <b>{% trans "Objective of trip" %}</b>
                        <span>${t.request_obj.objective_of_event | nz}</span>
                      </p>
                      <p>
                        <b>{% trans "Benefits to DFO" %}</b>
                        <span>${t.request_obj.benefit_to_dfo | nz}</span>
                      </p>
                      <p v-if="t.request_obj.late_justification">
                        <b>${requestLabels.late_justification}</b>
                        <span>${t.request_obj.late_justification}</span>
                      </p>
                    </div>

                    <hr>
                    <h4 v-if="trip">{% trans "Traveller Level" %}</h4>

                    <p v-if="!t.is_public_servant">
                      <b>{% trans "Company / Organization:" %}</b>
                      <span v-if="t.company_name" class="ml-1">${t.company_name}</span>
                      <span v-else class="ml-1 red-font">{% trans "missing!" %}</span>
                    </p>

                    <p>
                      <b>{% trans "Address:" %}</b>
                      <span v-if="t.address" class="ml-1">${t.address}</span>
                      <span v-else class="ml-1 red-font">{% trans "missing!" %}</span>
                    </p>

                    <p>
                      <b>{% trans "Phone:" %}</b>
                      <span v-if="t.phone" class="ml-1">${t.phone}</span>
                      <span v-else class="ml-1 red-font">{% trans "missing!" %}</span>
                    </p>

                    <p>
                      <b>{% trans "E-mail:" %}</b>
                      <a v-if="t.email" class="ml-1" :href="t.email">${t.email}</a>
                      <span v-else class="ml-1 red-font">{% trans "missing!" %}</span>
                    </p>


                    <p><b>{% trans "Public servant:" %}</b><span class="ml-1">${t.is_public_servant|yesNo}</span></p>
                    <p><b>{% trans "Research scientist:" %}</b><span class="ml-1">${t.is_research_scientist|yesNo}</span></p>
                    <p><b>{% trans "Travel dates:" %}</b><span class="ml-1" v-html="t.dates"></span></p>
                    <p><b>{% trans "Departure location:" %}</b><span class="ml-1" v-html="t.departure_location"></span></p>
                    <p><b>${travellerLabels.role}</b><span class="ml-1" v-html="t.long_role"></span></p>
                    <p><b>{% trans "Part of learning plan:" %}</b><span class="ml-1">${t.learning_plan|yesNo}</span></p>
                    <p><b>{% trans "Non-DFO funding:" %}</b><span class="ml-1" v-html="t.non_dfo_costs_html"></span></p>

                    <div v-if="trip && t.is_public_servant">
                      <p><b>{% trans "Travel History (ADM approved only):" %}</b></p>
                      <ul class="ml-5">
                        <li v-for="(r,i) in t.adm_travel_history" :key="r.id">
                          <a :href="`/travel-plans/requests/${r.id}/view/`" target="_blank" data-toggle="tooltip" title="{% trans "open in new window" %}">
                            <span class="mdi mdi-arrow-top-right text-primary table-bordered"></span> ${r.display}
                          </a>
                          <span :class="r.status_class + ' px-1 py-0'">${r.status_display}</span>
                        </li>
                        <li v-if="!t.adm_travel_history.length">
                          <em>{% trans "This traveller has no prior approved ADM requests on file." %}</em>
                        </li>
                      </ul>
                    </div>


                    <div v-if="canModify && !isReview && !trip">
                      {% include "travel/common/_costs.html" %}
                    </div>
                    <div v-else>
                      <b>{% trans "Cost Breakdown:" %}</b>
                      <span class="ml-1" v-html="t.cost_breakdown_html"></span>
                    </div>

                    <div class="float-right">
                      <button v-if="!isReview && canModify && !trip" @click="editTraveller(t)" class="btn btn-sm btn-warning">{% trans "Edit" %}</button>
                      <button v-if="!isReview && canModify && !trip" @click="addTraveller(t)" class="btn btn-sm btn-dark">{% trans "Clone" %}</button>
                      <button v-if="canModify" @click="deleteTraveller(t)" class="btn btn-sm btn-danger">{% trans "Remove" %}</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div v-else>
            <form @submit.prevent="updateTraveller">
              <div v-if="cloningTraveller" class="alert alert-info" role="alert">
                <h4>{% trans "CLONING: " %} ${travellerToEdit.old_name}</h4>
                <p class="h5">
                  {% trans "Please enter the new traveller information below." %}
                </p>
              </div>

              <div class="form-group">
                <label for="">
                  ${travellerLabels.user}
                  <span v-if="helpText.user" @mouseover="enablePopovers" class="mdi mdi-help-circle-outline" data-toggle="popover"
                        data-trigger="hover" :title="travellerLabels.user"
                        :data-content="helpText.user"></span>
                </label>
                <v-select
                  style="width: 100%"
                  v-model="travellerToEdit.user"
                  :options="dmAppsUsers"
                  label='full_name'
                  :reduce="full_name => full_name.id"
                  :clearable="false"
                  placeholder="{% trans "Start typing to search for a user" %}"
                >
                </v-select>
              </div>
              <div class="form-group">
                <label for="">
                  ${travellerLabels.is_public_servant}
                  <span v-if="helpText.is_public_servant" @mouseover="enablePopovers" class="mdi mdi-help-circle-outline" data-toggle="popover"
                        data-trigger="hover" :title="travellerLabels.is_public_servant"
                        :data-content="helpText.is_public_servant"></span>
                </label>
                <select v-model="travellerToEdit.is_public_servant" class="form-control form-control-sm" required ref="traveller_form_starting_point">
                  <option v-for="(obj, index) in yesNoChoices" :value="obj.value">${obj.text}</option>
                </select>
              </div>
              <div class="form-group" v-if="travellerToEdit.is_public_servant">
                <label for="">
                  ${travellerLabels.is_research_scientist}
                  <span v-if="helpText.is_research_scientist" @mouseover="enablePopovers" class="mdi mdi-help-circle-outline" data-toggle="popover"
                        data-trigger="hover" :title="travellerLabels.is_research_scientist"
                        :data-content="helpText.is_research_scientist"></span>
                </label>
                <select v-model="travellerToEdit.is_research_scientist" class="form-control form-control-sm" required>
                  <option v-for="(obj, index) in yesNoChoices" :value="obj.value">${obj.text}</option>
                </select>
              </div>
              <div class="form-group" v-if="!travellerToEdit.user">
                <label for="">
                  ${travellerLabels.first_name}
                  <span v-if="helpText.first_name" @mouseover="enablePopovers" class="mdi mdi-help-circle-outline" data-toggle="popover"
                        data-trigger="hover" :title="travellerLabels.first_name"
                        :data-content="helpText.first_name"></span>
                </label>
                <input type="text" v-model="travellerToEdit.first_name" class="form-control form-control-sm" required>
              </div>
              <div class="form-group" v-if="!travellerToEdit.user">
                <label for="">
                  ${travellerLabels.last_name}
                  <span v-if="helpText.last_name" @mouseover="enablePopovers" class="mdi mdi-help-circle-outline" data-toggle="popover"
                        data-trigger="hover" :title="travellerLabels.last_name"
                        :data-content="helpText.last_name"></span>
                </label>
                <input type="text" v-model="travellerToEdit.last_name" class="form-control form-control-sm" required>
              </div>
              <div class="form-group">
                <label for="">
                  ${travellerLabels.address}
                  <span v-if="helpText.address" @mouseover="enablePopovers" class="mdi mdi-help-circle-outline" data-toggle="popover"
                        data-trigger="hover" :title="travellerLabels.address"
                        :data-content="helpText.address"></span>
                </label>

                <select v-if="!useCustomAddress" v-model="travellerToEdit.address" class="form-control form-control-sm">
                  <option :value="null"> ------</option>
                  <option v-for="(obj, index) in orgChoices" :value="obj.value">${obj.text}</option>
                </select>
                <input v-else type="text" v-model="travellerToEdit.address" class="form-control form-control-sm"
                       placeholder="{% trans "Please enter address" %}">

                <button v-if="!travellerToEdit.address" type="button" @click="useCustomAddress = !useCustomAddress"
                        class="btn btn-sm btn-dark text-light px-1 py-0 mt-1">
                  <span v-if="!useCustomAddress"><span class="mdi mdi-keyboard text-light mr-3"></span>{% trans "Enter manually" %}</span>
                  <span v-else><span class="mdi mdi-form-dropdown text-light mr-3"></span>{% trans "Use a Predefined Address" %}</span>
                </button>
              </div>
              <div class="form-group">
                <label for="">
                  ${travellerLabels.phone}
                  <span v-if="helpText.phone" @mouseover="enablePopovers" class="mdi mdi-help-circle-outline" data-toggle="popover"
                        data-trigger="hover" :title="travellerLabels.phone"
                        :data-content="helpText.phone"></span>
                </label>
                <input type="text" v-model="travellerToEdit.phone" class="form-control form-control-sm">
              </div>
              <div class="form-group" v-if="!travellerToEdit.user">
                <label for="">
                  ${travellerLabels.email}
                  <span v-if="helpText.email" @mouseover="enablePopovers" class="mdi mdi-help-circle-outline" data-toggle="popover"
                        data-trigger="hover" :title="travellerLabels.email"
                        :data-content="helpText.email"></span>
                </label>
                <input type="text" v-model="travellerToEdit.email" class="form-control form-control-sm" required>
              </div>
              <div class="form-group" v-if="!travellerToEdit.is_public_servant">
                <label for="">
                  ${travellerLabels.company_name}
                  <span v-if="helpText.company_name" @mouseover="enablePopovers" class="mdi mdi-help-circle-outline" data-toggle="popover"
                        data-trigger="hover" :title="travellerLabels.company_name"
                        :data-content="helpText.company_name"></span>
                </label>
                <input type="text" v-model="travellerToEdit.company_name" class="form-control form-control-sm" required>
              </div>
              <div class="form-group">
                <label for="">
                  ${travellerLabels.departure_location}
                  <span v-if="helpText.departure_location" @mouseover="enablePopovers" class="mdi mdi-help-circle-outline" data-toggle="popover"
                        data-trigger="hover" :title="travellerLabels.departure_location"
                        :data-content="helpText.departure_location"></span>
                </label>
                <input type="text" v-model="travellerToEdit.departure_location" class="form-control form-control-sm" required>
              </div>
              <div class="form-group">
                <label for="">
                  ${travellerLabels.start_date}
                  <span v-if="helpText.start_date" @mouseover="enablePopovers" class="mdi mdi-help-circle-outline" data-toggle="popover"
                        data-trigger="hover" :title="travellerLabels.start_date"
                        :data-content="helpText.start_date"></span>
                </label>
                <input type="date" v-model="travellerToEdit.start_date" class="form-control form-control-sm" required>
              </div>
              <div class="form-group">
                <label for="">
                  ${travellerLabels.end_date}
                  <span v-if="helpText.end_date" @mouseover="enablePopovers" class="mdi mdi-help-circle-outline" data-toggle="popover"
                        data-trigger="hover" :title="travellerLabels.end_date"
                        :data-content="helpText.end_date"></span>
                </label>
                <input type="date" v-model="travellerToEdit.end_date" class="form-control form-control-sm" required>
              </div>
              <div class="form-group">
                <label for="">
                  ${travellerLabels.role}
                  <span v-if="helpText.role" @mouseover="enablePopovers" class="mdi mdi-help-circle-outline" data-toggle="popover"
                        data-trigger="hover" :title="travellerLabels.role"
                        :data-content="helpText.role"></span>
                </label>
                <select v-model="travellerToEdit.role" class="form-control form-control-sm">
                  <option v-for="(obj, index) in travellerRoleChoices" :value="obj.value">${obj.text}</option>
                </select>
              </div>
              <div class="form-group">
                <label for="">
                  ${travellerLabels.role_of_participant}
                  <span v-if="helpText.role_of_participant" @mouseover="enablePopovers" class="mdi mdi-help-circle-outline" data-toggle="popover"
                        data-trigger="hover" :title="travellerLabels.role_of_participant"
                        :data-content="helpText.role_of_participant"></span>
                </label>
                <textarea v-model="travellerToEdit.role_of_participant" class="form-control form-control-sm"></textarea>
              </div>
              <div class="form-group">
                <label for="">
                  ${travellerLabels.learning_plan}
                  <span v-if="helpText.learning_plan" @mouseover="enablePopovers" class="mdi mdi-help-circle-outline" data-toggle="popover"
                        data-trigger="hover" :title="travellerLabels.learning_plan"
                        :data-content="helpText.learning_plan"></span>
                </label>
                <select v-model="travellerToEdit.learning_plan" class="form-control form-control-sm" required>
                  <option v-for="(obj, index) in yesNoChoices" :value="obj.value">${obj.text}</option>
                </select>
              </div>
              <div class="form-group">
                <label for="">
                  ${travellerLabels.non_dfo_costs}
                  <span v-if="helpText.non_dfo_costs" @mouseover="enablePopovers" class="mdi mdi-help-circle-outline" data-toggle="popover"
                        data-trigger="hover" :title="travellerLabels.non_dfo_costs"
                        :data-content="helpText.non_dfo_costs"></span>
                </label>
                <input type="number" step=".01" v-model="travellerToEdit.non_dfo_costs" class="form-control form-control-sm">
              </div>
              <div class="form-group">
                <label for="">
                  ${travellerLabels.non_dfo_org}
                  <span v-if="helpText.non_dfo_org" @mouseover="enablePopovers" class="mdi mdi-help-circle-outline" data-toggle="popover"
                        data-trigger="hover" :title="travellerLabels.non_dfo_org"
                        :data-content="helpText.non_dfo_org"></span>
                </label>
                <input type="text" v-model="travellerToEdit.non_dfo_org" class="form-control form-control-sm">
              </div>
              <div class="form-group">
                <label for="">
                  ${travellerLabels.notes}
                  <span v-if="helpText.notes" @mouseover="enablePopovers" class="mdi mdi-help-circle-outline" data-toggle="popover"
                        data-trigger="hover" :title="travellerLabels.notes"
                        :data-content="helpText.notes"></span>
                </label>
                <textarea v-model="travellerToEdit.notes" class="form-control form-control-sm"></textarea>
              </div>

              <div class="float-right">
                <button type="submit" class="btn btn-sm btn-success text-light">{% trans "Save" %}</button>
                <button type="button" @click="cancelTravellerEdit" class="btn btn-sm btn-secondary text-light">{% trans "Cancel" %}</button>
              </div>
              <div v-if="errorMsgTraveller" class="alert alert-danger py-1 mt-3" role="alert" style="width: 80%">
                <p class="mb-0">
                  <span class="h5 mdi mdi-alert-decagram-outline mr-3"></span>
                  <span class="h6">${errorMsgTraveller}</span>
                </p>
              </div>

            </form>
          </div>
        </div>
        <div v-else>
          <em v-if="trip">{% trans "There are no travellers associated with this trip" %}</em>
          <em v-else>{% trans "There are no travellers associated with this request" %}</em>
        </div>
      </div>
    </div>
  </div>
</div>
