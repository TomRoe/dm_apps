{% extends "travel/base.html" %}
{% load static %}
{% load bootstrap4 %}
{% load verbose_names %}
{% load custom_filters %}
{% load custom_tags %}
{% load i18n %}
{% load humanize %}

{% block area_above_h1 %}
  {# if trip is cancelled, display a warning #}
  {% if trip.status.id == 43 %}
    <div class="alert alert-danger" role="alert">
      <h4 class="alert-heading">
        {% trans "WARNING" %}
      </h4>
      <p>
        {% trans "The trip associated with this request has been cancelled." %}
      </p>
    </div>
  {% elif object.is_late_request and not object.submitted %}
    <div class="alert alert-danger" role="alert">
      <h4 class="alert-heading red-font">
        {% trans "WARNING" %}
      </h4>
      <p class="h5">
        {% if trip.status.id == 31 %}
          {% trans "This trip is currently under review from NCR." %}
        {% elif trip.status.id == 32 %}
          {% trans "This trip has already been reviewed by NCR." %}
        {% endif %}
        {% trans "In order to submit this request, you will need to provide a justification for the late submission." %}
      </p>
    </div>

  {% elif trip.is_adm_approval_required and not triprequest.submitted %}

    {% if trip.days_until_eligible_for_adm_review > 45 %}
      {% echo "success" as btn_color %}
    {% elif trip.days_until_eligible_for_adm_review >= 15 %}
      {% echo "warning" as btn_color %}
    {% else %}
      {% echo "danger" as btn_color %}
    {% endif %}

    <div class="alert alert-{{ btn_color }}" role="alert">
      <h5 class="alert-heading">
        {% trans "Just a heads up..." %}
      </h5>
      <p>
        {% if trip.days_until_eligible_for_adm_review < 0 %}
          {% blocktrans with trip.date_eligible_for_adm_review|naturaltime as time %}
            This trip was eligible for review by the ADM office {{ time }}.
          {% endblocktrans %}
        {% else %}
          {% blocktrans with trip.date_eligible_for_adm_review|naturaltime as time %}
            This trip will be eligible for review by the ADM office in {{ time }}.
          {% endblocktrans %}
        {% endif %}
      </p>
    </div>
  {% endif %}

{% endblock %}


{% block subcontent %}
  <div id="app">
    {% if is_current_reviewer and object.submitted %}
      <div class="alert alert-info" role="alert">
        <h4 class="">
          <span class="mdi mdi-information-outline h4"></span>
          {% trans "You are able to edit this record because you are " %}
          {% if is_admin %}
            {% trans "an application administrator." %}
          {% else %}
            {% trans "the current reviewer." %}
          {% endif %}
        </h4>
      </div>
    {% endif %}

    <div class="float-right">
      {% if object.current_reviewer.user == user %}
        <a href="{% url 'travel:tr_review_update' object.current_reviewer.id %}" class="btn btn-lg btn-outline-primary">
          {% trans "Back to Approver Panel" %}
        </a>

      {% endif %}
    </div>


    {# ADMIN BUTTON GROUP #}

    <div class="btns mb-3">
      {% if is_admin %}

        {# ADMIN NOTES #}
        <a class="btn btn-admin" href="#" pop-href="{% url 'travel:admin_notes_edit' object.id %}">
          {% trans "Administrative Notes" %}
        </a>


        {# ADMIN CANCEL BUTTON - only show this option for approved requests #}
        {% if object.status.id  != 22 and object.status.id  != 10 %}
          {% echo "danger" as cancel_btn_color %}
          {% trans "Cancel Request" as cancel_btn_text %}

          <span data-toggle="tooltip" title="{% trans "This is only an option to you as a system admin" %}">
                        <a class="btn btn-admin" href="{% url 'travel:request_cancel' object.id view.kwargs.type %}">
                        {{ cancel_btn_text }}
                        </a>
                        </span>
        {% endif %}
      {% endif %}
    </div>

    <div class="float-right ">

      {#        <a class="btn btn-outline-dark" href="{% url 'travel:export_cfts_request' triprequest.id %}">#}
      {#            {% trans "CFTS Report for this Request" %} &nbsp; <img src="{% static 'img/icons/excel.svg' %}" alt="" width="20px">#}
      {#        </a>#}
    </div>

    <div class="btns mb-3">

      {# SUBMIT BUTTON #}
      {% if object.status.id == 11 or object.status.id == 22 %} {# disabled for everyone #}
        {% echo "disabled" as submit_disabled_var %}
        {% trans "Approved or cancelled requests cannot by unsubmitted." as submit_tip_text %}
        {#                {% elif object.submitted and not is_admin and not is_owner %}#}
      {% elif not can_modify and not is_owner %} {# owners can always unsubmit #}
        {% echo "disabled" as submit_disabled_var %}
        {% trans "You do not have permissions to submit / un-submit this request" as submit_tip_text %}

      {% elif not object.submitted and object.is_late_request and not object.late_justification %}
        {% echo "disabled" as submit_disabled_var %}
        {% trans "You must provide a late justification in order to submit this trip." as submit_tip_text %}
      {% endif %}

      {% if object.submitted %}
        {% echo "secondary" as submit_btn_color %}
      {% else %}
        {% echo "success" as submit_btn_color %}
      {% endif %}

      {% if object.submitted %}
        {% trans "Un-submit" as submit_btn_text %}
      {% else %}
        {% if object.status.id == 16 %}
          {% trans "Re-submit" as submit_btn_text %}
        {% else %}
          {% trans "Submit" as submit_btn_text %}
        {% endif %}
      {% endif %}

      <span data-toggle="tooltip" title="{{ submit_tip_text }}">
                <a class="btn btn-{{ submit_btn_color }} {{ submit_disabled_var }}"
                   href="{% url 'travel:request_submit' object.id view.kwargs.type %}">{{ submit_btn_text }}</a>
                </span>

      {# EDIT BUTTON #}
      {% if not can_modify %}
        {% echo "disabled" as edit_disabled_var %}
        {% trans "Only application administrators and reviewers can modify a submitted request" as edit_tip_text %}
      {% endif %}

      <span data-toggle="tooltip" title="{{ edit_tip_text }}">
                <a class="btn btn-warning {{ edit_disabled_var }}" href="{% url 'travel:request_edit' object.id view.kwargs.type %}">
                    {% trans "Edit" %}
                </a>
                </span>

      {# DELETE BUTTON #}
      {% if object.submitted or object.status.id == 16 %}
        {% echo "disabled" as delete_disabled_var %}
        {% trans "Submitted trip requests cannot be deleted." as delete_tip_text %}
      {% endif %}

      <span data-toggle="tooltip" title="{{ delete_tip_text }}">
                <a class="btn btn-danger {{ delete_disabled_var }}" href="{% url 'travel:request_delete' object.id view.kwargs.type %}">
                {% trans "Delete" %}
                </a>
                </span>

      {# CLONE BUTTON #}
      <a class="btn btn-primary " href="{% url 'travel:request_clone' object.id view.kwargs.type %}">
        {% trans "Clone Me" %}
      </a>

      <a class="btn btn-outline-dark " href="{% url 'travel:request_print' triprequest.id %}">
        {% trans "Travel Request and Approval Form (TRAF)" %}&nbsp; <img src="{% static 'img/icons/pdf.svg' %}" alt="" width="20px">
      </a>

    </div>
    {# SUPERUSER DELETE BUTTON #}
    {#        {% if user.is_superuser %}#}
    {#            <a class="btn btn-danger" href="{% url 'travel:request_delete' object.id  view.kwargs.type %}">#}
    {#                {% trans "SUPERUSER DELETE!!" %}#}
    {#            </a>#}
    {#        {% endif %}#}

    {% include "travel/_trip_request_detail.html" %}

  </div>

{% endblock %}

{% block body_js %}

  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>

  <script type="application/javascript">
  var trip_request_id = {{ object.id }};
  </script>
  <script src="{% static 'travel/mainTripRequest.js' %}"></script>

  <script type="application/javascript">
  function refreshCosts() {
    setTimeout(app.getCosts, 500)
  }
  </script>

  {#  // have to reload some other JS scripts... due to import of vue js#}
  <script type="text/javascript" src="{% static "js/clickableTableRows.js" %}?version=1.1.7"></script>
  <script type=" text/javascript" src="{% static "js/popItOut.js" %}?version=1.2.2"></script>

{% endblock %}