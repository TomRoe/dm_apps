{% extends "oceanography/oceanography_base.html" %}
{% load bootstrap4 %}
{% load verbose_names %}
{% load static %}

{% block content %}
<style>
       /* Set the size of the div element that contains the map */
      #map,#lineMap {
        height: 500px;  /* The height is 400 pixels */
        width: 100%;  /* The width is the width of the web page */
       }
    </style>
  <div class="container">
    <h1>{{object.mission_name}}</h1>
    <div class="btn-group">
      <a href="{% url "oceanography:mission_edit" object.id %}" class="btn btn-warning">Edit</a>
      <a href="{% url "oceanography:bottle_list" object.id %}" class="btn btn-primary">View Bottles</a>
      <a href="{% url "oceanography:mission_export_csv" object.id %}" class="btn btn-success">Export CSV</a>
      <a href="{% url "oceanography:file_create" object.id %}" class="btn btn-info">Add a File</a>
      <a href="{% url "oceanography:mission_list" object.season %}" class="btn btn-dark">Back</a>
    </div>
    <br><br>

<div class="row">
  <div class="col">
        <p>
          <b>{%get_verbose_field_name object "mission_name" %}:</b><br>
          {{object.mission_name}}
        </p>
        <p>
          <b>{%get_verbose_field_name object "mission_number" %}:</b><br>
          {{object.mission_number}}
        </p>
        <p>
          <b>{%get_verbose_field_name object "vessel_name" %}:</b><br>
          {{object.vessel_name}}
        </p>
        <p>
          <b>{%get_verbose_field_name object "chief_scientist" %}:</b><br>
          {{object.chief_scientist}}
        </p>
        <p>
          <b>{%get_verbose_field_name object "samplers" %}:</b><br>
          {{object.samplers}}
        </p>
        <p>
          <b>{%get_verbose_field_name object "start_date" %}:</b><br>
          {{object.start_date}}
        </p>
        <p>
          <b>{%get_verbose_field_name object "probe" %}:</b><br>
          {{object.probe}}
        </p>
        <p>
          <b>{%get_verbose_field_name object "area_of_operation" %}:</b><br>
          {{object.area_of_operation}}
        </p>
        <p>
          <b>{%get_verbose_field_name object "notes" %}:</b><br>
          {{object.notes}}
        </p>



  </div>

  <div class="col">
    <p>
      <b>Files:</b>
      {# function popitup(url,windowName, height=500, width=500,top=50,left=200) #}
      {# <a class="btn btn-sm btn-light" onclick="return popitup('{% url 'tickets:file_create' ticket.id %}','FileCreate',500,1000)"> <i class="material-icons">add</i></a> #}

      <ul>
        {% for file in object.files.all  %}
          <li>
            {# <a href="." onclick="return popitup('{% url 'tickets:file_detail' ticket=object.id pk=file.id %}','FileDetail',500,1000)">{{file.caption}}</a> (uploaded on: {{file.date_created|date:"F d Y"}}) #}
            <a href="{% url "oceanography:file_detail" file.id %}">{{file.caption}}</a> (uploaded on: {{file.date_created|date:"F d Y"}})
          </li>
        {% empty %}
          <span class="">  <em>There are no files attached to this mission.</em></span>

        {% endfor %}
      </ul>
    </p>
    <br>
    <b>Map:</b>

    <div id="map"></div>
    <div id="lineMap"></div>
  </div>
  </div>
</div>

<script>
    function initialize() {
      var locations = [

        {% for bottle in object.bottles.all %}
          {% if bottle.lat_DDdd and bottle.long_DDdd %}
            ['<a href="{% url 'oceanography:bottle_detail' bottle.id %}">Bottle {{bottle.bottle_uid}}</a>',{{bottle.lat_DDdd}}, {{bottle.long_DDdd}}, '{% static "/img/grais/red_MarkerL.png" %}'],
          {% endif %}
        {% endfor %}
      ];
      window.map = new google.maps.Map(document.getElementById('map'), {
          mapTypeId: google.maps.MapTypeId.ROADMAP
      });

      var infowindow = new google.maps.InfoWindow();

      var bounds = new google.maps.LatLngBounds();

      for (i = 0; i < locations.length; i++) {
          marker = new google.maps.Marker({
              position: new google.maps.LatLng(locations[i][1], locations[i][2]),
              map: map,
              // icon: locations[i][3]
          });

          bounds.extend(marker.position);

          google.maps.event.addListener(marker, 'click', (function (marker, i) {
              return function () {
                  infowindow.setContent(locations[i][0]);
                  infowindow.open(map, marker);
              }
          })(marker, i));
      }

      map.fitBounds(bounds);

      var flightPlanCoordinates = [
        {% for bottle in object.bottles.all %}
          {% if bottle.lat_DDdd and bottle.long_DDdd %}
            {lat: {{bottle.lat_DDdd}}, lng: {{bottle.long_DDdd}}},
          {% endif %}
        {% endfor %}
      ];

      var flightPath = new google.maps.Polyline({
        path: flightPlanCoordinates,
        geodesic: true,
        strokeColor: '#0133FE',
        strokeOpacity: 1.0,
        strokeWeight: 2
      });

      flightPath.setMap(map);
    }

    function loadScript() {
      var script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = "https://maps.googleapis.com/maps/api/js?key={{google_api_key}}&callback=initialize";
      document.body.appendChild(script);
    }

    window.onload = loadScript;

</script>

{% endblock content %}
