{% extends "res/base.html" %}
{% load static %}
{% load bootstrap4 %}
{% load verbose_names %}
{% load custom_filters %}
{% load i18n %}

{% block crumbs %}
{% endblock %}

{% block messages %}{% endblock %}
{% block title_area %}
{% endblock %}

{% block header %}
  {{ block.super }}

{% endblock %}

{% block subcontent %}
  <div id="app" v-cloak>
    <div>
      <div>
        {% include "shared_models/_generic_breadcrumbs.html" %}
        <div class="mb-3">
          <h2 class="">{{ h1|safe }}</h2>
          <p class="lead text-muted mt-1 mb-0 small">{% trans "Application ID:" %} {{ object.id }}</p>
        </div>
        {% bootstrap_messages %}

        <div v-if="canModify" class="alert alert-primary no-print" role="alert">
          <p class="mb-0">
            <span class="h5 mdi mdi-information-outline mr-3"></span> <span class="h6">${currentUser.can_modify.reason}</span>
          </p>
        </div>

        <div class="mb-3 float-right">
          {% if object.submission_date %}
            <button v-if="!application.review" class="btn btn-sm btn-dark" @click="primeReview">{% trans "Start a Review" %}</button>
            {% if not object.processes.exists %}
              <a v-if="canModify" class="btn btn-sm btn-dark" href="{% url 'res:process_new' %}?request={{ object.id }}">{% trans "Start a Process" %}</a>
            {% endif %}
          {% endif %}
        </div>
        <div class="mb-3">
          {#            <a v-if="canModify" class="btn btn-sm btn-warning" href="{% url 'res:application_edit' object.id %}">{% trans "Edit" %}</a>#}

          <span v-if="canModify">
{#              <a v-if="application.submission_date" class="btn btn-sm btn-primary" href="{% url 'res:application_submit' object.id %}">#}
              <a v-if="application.submission_date" class="btn btn-sm btn-primary" href="#">
                {% trans "Un-Submit" %}
              </a>
{#              <a v-else-if="application.is_complete" class="btn btn-sm btn-primary" href="{% url 'res:application_submit' object.id %}">#}
              <a v-else-if="application.is_complete" class="btn btn-sm btn-primary" href="#">
                {% trans "Submit" %}
              </a>
              <span v-else class="helper" data-toggle="tooltip" title="{% trans "All fields are mandatory before approvals and submission" %}">
                <a class="btn btn-sm btn-primary disabled" href="">
                  {% trans "Submit" %}
                </a>
              </span>
            </span>

          <a v-if="canModify" class="btn btn-sm btn-danger" href="{% url 'res:application_delete' object.id %}">{% trans "Delete" %}</a>
          <a class="btn btn-sm btn-secondary helper"
             data-toggle="tooltip" title="{% trans "Click here to clone this application into a new application" %}"
             href="#">{% trans "Clone Me" %}</a>

          {% if object.status >= 2 %}
            <a href="#" class="btn btn-outline-dark btn-sm ml-3">
              <span class="mdi mdi-file-pdf mr-1"></span>{% trans "Export to PDF" %}
            </a>
          {% endif %}
        </div>
        <div v-if="loadingApplication" class="loading mb-3 mt-3 mt-5">
          <div class="spinner-border mb-3" style="width: 5rem; height: 5rem;" role="status">
            <span class="sr-only"></span>
          </div>
        </div>
        <div v-else class="table table-sm">
          <editable-cell
            :label="applicationLabels.fiscal_year"
            :object="application"
            field="fiscal_year_display"
          >
          </editable-cell>
          <editable-cell
            :label="applicationLabels.current_position_title"
            :object="application"
            field="current_position_title"
            :editable="true"
            :class="{'bad':unsavedChanges}"
            @change="updateApplication"
            @keypress="unsavedChanges=true"
          >
          </editable-cell>

          <editable-cell
            input_type="textarea"
            rows="10"
            :label="applicationLabels.academic_background"
            :object="application"
            field="academic_background"
            display_field="academic_background_html"
            :editable="true"
            :class="{'bad':unsavedChanges}"
            @change="updateApplication"
            @keypress="unsavedChanges=true"
          >
          </editable-cell>

          academic_background
          employment_history
          objectives
          relevant_factors


          {#              <tr>#}
          {#                <th class="text-left w250" v-html="applicationLabels.status"></th>#}
          {#                <td class="text-left" v-html="application.status_display_html"></td>#}
          {#              </tr>#}
          {#              <tr>#}
          {#                <th class="text-left w250" v-html="applicationLabels.applicant"></th>#}
          {#                <td>#}
          {#                  <editable-cell type="number" rows="5" :val="application.applicant"></editable-cell>#}
          {#                </td>#}
          {#              </tr>#}
          {#              <tr>#}
          {#                <th class="text-left w250" v-html="applicationLabels.applicant"></th>#}
          {#                <td>#}
          {#                  <editable-cell type="number" rows="5" :val="application.applicant"></editable-cell>#}
          {#                </td>#}
          {#              </tr>#}
          {#              <tr>#}
          {#                <th class="text-left w250" v-html="applicationLabels.objectives"></th>#}
          {#                <td>#}
          {#                  <editable-cell type="textarea" rows="5" :val="application.objectives"></editable-cell>#}
          {#                </td>#}
          {#              </tr>#}

          {#                <tr>#}
          {#                  <th class="text-left">{% trans "is carry over?" %}</th>#}
          {#                  <td class="text-left">${application.is_carry_over|yesNo}</td>#}
          {#                </tr>#}
          {#                <tr>#}
          {#                  <th class="text-left" v-html="applicationLabels.language"></th>#}
          {#                  <td class="text-left" v-html="application.language_display"></td>#}
          {#                </tr>#}
          {#                <tr>#}
          {#                  <th class="text-left" v-html="applicationLabels.section"></th>#}
          {#                  <td class="text-left" v-html="application.section_display"></td>#}
          {#                </tr>#}
          {#                <tr>#}
          {#                  <th class="text-left" v-html="applicationLabels.coordinator"></th>#}
          {#                  <td class="text-left" v-html="application.coordinator"></td>#}
          {#                </tr>#}
          {#                <tr>#}
          {#                  <th class="text-left" v-html="applicationLabels.client"></th>#}
          {#                  <td class="text-left" v-html="application.client"></td>#}
          {#                </tr>#}
          {#                <tr>#}
          {#                  <th class="text-left">{% trans "Multiregional / multisector?" %}</th>#}
          {#                  <td class="text-left" v-html="application.multiregional_display"></td>#}
          {#                </tr>#}
          {#                <tr>#}
          {#                  <th class="text-left" v-html="applicationLabels.issue"></th>#}
          {#                  <td class="text-left" v-html="application.issue_html"></td>#}
          {#                </tr>#}
          {#                <tr>#}
          {#                  <th class="text-left">{% trans "Assistance from DFO Science" %}</th>#}
          {#                  <td class="text-left" v-html="application.assistance_text"></td>#}
          {#                </tr>#}
          {#                <tr>#}
          {#                  <th class="text-left" v-html="applicationLabels.rationale"></th>#}
          {#                  <td class="text-left" v-html="application.rationale_html"></td>#}
          {#                </tr>#}
          {#                <tr>#}
          {#                  <th class="text-left" v-html="applicationLabels.risk_text"></th>#}
          {#                  <td class="text-left" v-html="application.risk_text_html"></td>#}
          {#                </tr>#}
          {#                <tr>#}
          {#                  <th class="text-left" v-html="applicationLabels.advice_needed_by"></th>#}
          {#                  <td class="text-left" v-html="application.advice_needed_by_display"></td>#}
          {#                </tr>#}
          {#                <tr>#}
          {#                  <th class="text-left" v-html="applicationLabels.rationale_for_timeline"></th>#}
          {#                  <td class="text-left" v-html="application.rationale_for_timeline"></td>#}
          {#                </tr>#}
          {#                <tr>#}
          {#                  <th class="text-left">{% trans "Client funding?" %}</th>#}
          {#                  <td class="text-left" v-html="application.funding_display"></td>#}
          {#                </tr>#}
          {#                <tr>#}
          {#                  <th class="text-left">{% trans "Client prioritization?" %}</th>#}
          {#                  <td class="text-left" v-html="application.prioritization_display"></td>#}
          {#                </tr>#}
          {#                <tr>#}
          {#                  <th class="text-left" v-html="applicationLabels.submission_date"></th>#}
          {#                  <td class="text-left" v-html="application.submission_date_display"></td>#}
          {#                </tr>#}
          {#                <tr>#}
          {#                  <th class="text-left" v-html="applicationLabels.uuid"></th>#}
          {#                  <td class="text-left" v-html="application.uuid"></td>#}
          {#                </tr>#}

          {#              <tr>#}
          {#                <th class="text-left">{% trans "Metadata" %}</th>#}
          {#                <td class="text-left" v-html="application.metadata"></td>#}
          {#              </tr>#}
        </div>
        {# Notes #}
      </div>
    </div>
  </div>



{% endblock %}


{% block body_js %}
  {{ block.super }}
  {% include "res/components/editable_cell.html" %}

  <script type="application/javascript">
  var applicationId = "{{ object.id }}"

  // register vue-select
  Vue.component('v-select', VueSelect.VueSelect);

  // vuejs instance
  var app = new Vue({
    el: '#app',
    delimiters: ["${", "}"],
    data: {
      currentUser: {},
      loadingApplication: false,
      application: {},
      applicationLabels: {},
      errors: null,
      unsavedChanges: false, // currently unused
      applicationErrorMsg: null, // currently unused
      //prioritizationChoices: [],
      //decisionChoices: [],
      //notes: [],
      //showSidebar: true,
    },
    methods: {
      getCurrentUser() {
        let endpoint = `/api/res/user/?application=${applicationId}`;
        apiService(endpoint)
            .then(response => {
              this.currentUser = response;
            })
      },
      getApplication() {
        loadingApplication = true;
        let endpoint = `/api/res/applications/${applicationId}/`;
        apiService(endpoint).then(data => {
          if (data) {
            this.application = data;
            loadingApplication = false;
          }
        });
      },
      cleanApplication(application) {
        //sample.datetime = sample.datetime_display
        for (const applicationKey in application) {
          if (application[applicationKey] === "") application[applicationKey] = null;
        }
        return application;
      },

      updateApplication(application) {
        this.applicationErrorMsg = null;
        endpoint = `/api/res/applications/${application.id}/`;
        application = this.cleanApplication(application);
        apiService(endpoint, "PUT", application)
            .then(response => {
              console.log(response)
              if (!response.id) {
                this.applicationErrorMsg = groomJSON(response);
              } else {
                this.unsavedChanges = false;
              }
              this.getApplication(application)
            })
      },


      getModelMetadata() {
        apiService(`/api/res/meta/models/application/`).then(data => {
          this.applicationLabels = data.labels;
        });
      },
    },
    computed: {
      canModify() {
        return this.currentUser.can_modify && this.currentUser.can_modify.can_modify;
      }
    },
    filters: {
      yesNo: vueFiltersObject["yesNo"],
      nz: vueFiltersObject["nz"],
    },
    created() {
      this.getModelMetadata();
      this.getCurrentUser();
      this.getApplication();
      {#this.getReviewMetadata();#}
    },
  });


  </script>

{% endblock %}