{% extends "csas2/base.html" %}
{% load static %}
{% load bootstrap4 %}
{% load verbose_names %}
{% load custom_filters %}
{% load i18n %}

{% block crumbs %}
{% endblock %}

{% block messages %}{% endblock %}
{% block title_area %}
{% endblock %}

{% block header %}
  {{ block.super }}

{% endblock %}

{% block subcontent %}
  <div id="app" @keydown.esc.prevent="closeModals()" v-cloak>
    <div>
      {% include "shared_models/_generic_breadcrumbs.html" %}
      <div class="mb-3">
        <h2 class="">{{ h1|safe }}</h2>
      </div>
      {% bootstrap_messages %}
      <div v-if="canModify" class="alert alert-primary no-print" role="alert" style="width: 60%">
        <p class="mb-0">
          <span class="h5 mdi mdi-information-outline mr-3"></span> <span class="h6">${currentUser.reason}</span>
        </p>
      </div>
    </div>

    <div class="mb-3">
      <a class="btn btn-sm btn-warning" href="{% url 'csas2:meeting_edit' object.id %}">{% trans "Edit" %}</a>
      <a class="btn btn-sm btn-danger" href="{% url 'csas2:meeting_delete' object.id %}">{% trans "Delete" %}</a>
    </div>

    <div class="row">
      <div class="col-8">


        <div class="mb-5">
          <table class="table table-sm">
            {% for field in meeting_field_list %}
              {% verbose_td_display object field th_width="300px" %}
            {% endfor %}
            <tr>
              <th>
                {% trans "Linked documents" %}
              </th>
              <td>
                {% if object.documents.exists %}
                  {% for obj in object.documents.all %}
                    <div>
                      <a href="{% url 'csas2:document_detail' obj.id %}">{{ obj }}</a>
                    </div>
                  {% endfor %}
                {% else %}
                  <em>{% trans "There are no documents linked to this meeting." %}</em>
                {% endif %}
              </td>
            </tr>

          </table>
        </div>

        <div class="mb-5">
          <div class="mb-3 float-right">
            <a class="btn btn-sm btn-success" href="#"><span class="h5 mdi mdi-plus text-light"></span></a>
          </div>
          <h4>{% trans "Invitees" %}</h4>
          {% if object.invitees.exists %}

            <table class="table table-sm">
              <thead>
              <tr>
                {% for field in meeting_field_list %}
                  <th>{% get_verbose_label object.meetings.first field %}</th>
                {% endfor %}
              </tr>
              </thead>
              <tbody>
              {% for obj in object.meetings.all %}
                <tr href="" @click="followLink('{% url 'csas2:meeting_detail' obj.id %}')" class="pointy">
                  {% for field in meeting_field_list %}
                    <td>{% get_field_value obj field %}</td>
                  {% endfor %}
                </tr>
              {% endfor %}
              </tbody>
            </table>
          {% else %}
            <em>{% trans "No one has been invited to this meeting :(" %}</em>
          {% endif %}
        </div>

        <div class="mb-5">
          <div class="mb-3 float-right">
            <a class="btn btn-sm btn-success" href="#"><span class="h5 mdi mdi-plus text-light"></span></a>
          </div>
          <h4>{% trans "Resources" %}</h4>
          {% if object.invitees.exists %}

            <table class="table table-sm">
              <thead>
              <tr>
                {% for field in meeting_field_list %}
                  <th>{% get_verbose_label object.meetings.first field %}</th>
                {% endfor %}
              </tr>
              </thead>
              <tbody>
              {% for obj in object.meetings.all %}
                <tr href="" @click="followLink('{% url 'csas2:meeting_detail' obj.id %}')" class="pointy">
                  {% for field in meeting_field_list %}
                    <td>{% get_field_value obj field %}</td>
                  {% endfor %}
                </tr>
              {% endfor %}
              </tbody>
            </table>
          {% else %}
            <em>{% trans "This meeting has no associated resources." %}</em>
          {% endif %}
        </div>
      </div>

      {# Notes #}
      <div class="col">
        {% include "csas2/meeting_detail/_notes.html" %}
      </div>


    </div>

    {# Modals #}

    {% include "csas2/meeting_detail/_note_modal.html" %}

  </div>




{% endblock %}


{% block body_js %}
  {{ block.super }}
  <script type="application/javascript">
  var meetingId = "{{ object.id }}"

  // register vue-select
  Vue.component('v-select', VueSelect.VueSelect);

  // vuejs instance
  var app = new Vue({
    el: '#app',
    delimiters: ["${", "}"],
    data: {
      currentUser: {},
      canModify: false,
      loadingMeeting: false,

      meeting: {},
      notes: [],
      invitees: [],
      resources: [],

      showNoteModal: false,
      showInviteeModal: false,
      showResourceModal: false,
      meetingId: meetingId,

    },
    methods: {
      getCurrentUser() {
        let endpoint = `/api/csas/user/`;
        apiService(endpoint)
            .then(response => {
              this.currentUser = response;
            })
      },
      openPopout(url) {
        popitup(url, 'popoutWindow' + Date.now());
      },
      openNoteEditor(note) {
        if (!note.id) {

        }

      },
      primeNote() {
        this.note = {
          type: null,
          note: null,
          is_complete: false,
          event: this.event_id
        };
      },
      getNotes() {
        let endpoint = `/api/csas/notes/?meeting=${this.meeting.id}`;
        apiService(endpoint).then(data => {
          this.notes = data;
        });
      },
      getInvitees() {
        let endpoint = `/api/csas/invitees/?meeting=${this.meeting.id}`;
        apiService(endpoint).then(data => {
          this.invitees = data;
        });
      },
      getResources() {
        let endpoint = `/api/csas/resources/?meeting=${this.meeting.id}`;
        apiService(endpoint).then(data => {
          this.resources = data;
        });
      },
      getMeeting(update_notes) {
        let endpoint = `/api/csas/meetings/${this.meetingId}/`;
        apiService(endpoint).then(data => {
          if (data) {
            this.meeting = data;
            if (update_notes) this.notes = this.getNotes();
            this.invitees = this.getInvitees();
            this.resources = this.getResources();
          }
        });
      },


      getObservations() {
        this.loadingObservations = true;
        let endpoint;
        if (this.pageType === "samples") endpoint = `${this.endpointPrefix}/?sample=${objectId}`;
        else if (this.pageType === "lines") endpoint = `${this.endpointPrefix}/?line=${objectId}`;
        else if (this.pageType === "surfaces") endpoint = `${this.endpointPrefix}/?surface=${objectId}`;
        apiService(endpoint)
            .then(response => {
              if (response.length && response[0].id) {
                for (var i = 0; i < response.length; i++) {
                  if (response[i].observation_date) response[i].observation_date = response[i].observation_date.replace("Z", "")
                }
                this.observations = response;
                this.loadingObservations = false;
              }
            })
      },
      updateObservation(obs) {
        this.unsavedChanges = true;
        this.obsErrorMsg = null;
        let endpoint;
        let method;
        if (obs.id) {
          endpoint = `${this.endpointPrefix}/${obs.id}/`;
          method = "PUT";
        } else {
          endpoint = `${this.endpointPrefix}/`;
          method = "POST";
        }
        apiService(endpoint, method, obs)
            .then(response => {
              if (!response.id) this.obsErrorMsg = this.groomJSON(response);
              else {
                if (response.observation_date) response.observation_date = response.observation_date.replace("Z", "")
                this.$set(this.observations, this.observations.indexOf(obs), response)
                this.unsavedChanges = false;
              }
            })
      },
      deleteObservation(obs) {
        userInput = confirm("{% trans 'Are you sure you want to delete this observation?' %}");
        if (userInput) {
          if (obs.id) {
            let endpoint = `${this.endpointPrefix}/${obs.id}/`;
            apiService(endpoint, "DELETE")
                .then(response => {
                  this.$delete(this.observations, this.observations.indexOf(obs));
                })
          } else {
            this.$delete(this.observations, this.observations.indexOf(obs));
            this.unsavedChanges = false;
          }
        }
      },
      groomJSON(json) {
        return JSON.stringify(json).replaceAll("{", "").replaceAll("}", "").replaceAll("[", " ").replaceAll("]", " ").replaceAll('"', "").replaceAll("non_field_errors:", "")
      },

    },
    computed: {
      endpointPrefix() {
        return `/api/csas2/${this.pageType.slice(0, this.pageType.length - 1)}-species`
      },
      totalCoverage() {
        let total = 0;
        let obs;
        for (var i = 0; i < this.observations.length; i++) {
          obs = this.observations[i];
          if (obs.percent_coverage) total += Number(obs.percent_coverage);
        }
        return total
      }
    },
    created() {
      this.getMeeting(true);

      {#this.getObservations();#}
      {#this.getSpeciesMetadata();#}
    },
  });


  </script>

{% endblock %}