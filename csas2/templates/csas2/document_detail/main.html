{% extends "csas2/base.html" %}
{% load static %}
{% load bootstrap4 %}
{% load verbose_names %}
{% load custom_filters %}
{% load i18n %}

{% block crumbs %}
{% endblock %}

{% block messages %}{% endblock %}
{% block title_area %}
{% endblock %}

{% block header %}
  {{ block.super }}

{% endblock %}

{% block subcontent %}




  <div id="app" v-cloak>
    <div>
      {% include "shared_models/_generic_breadcrumbs.html" %}
      <div class="float-left">
        <span class="mdi mdi-file-document mr-3 h2"></span>
      </div>
      <div class="mb-3">
        <h2 class="">{{ h1|safe }}</h2>
      </div>
      {% bootstrap_messages %}
      <div v-if="canModify" class="alert alert-primary no-print" role="alert" style="width: 60%">
        <p class="mb-0">
          <span class="h5 mdi mdi-information-outline mr-3"></span> <span class="h6">${currentUser.reason}</span>
        </p>
      </div>
    </div>

    <div class="mb-3">
      <a class="btn btn-sm btn-warning" href="{% url 'csas2:document_edit' object.id %}">{% trans "Edit" %}</a>
      <a class="btn btn-sm btn-danger" href="{% url 'csas2:document_delete' object.id %}">{% trans "Delete" %}</a>
    </div>

    <div class="row">
      <div class="col-8">


        'year',
        'pub_number',
        'pages',
        'hide_from_list',
        'metadata|{}'.format(_("metadata")),

        <div class="mb-5">
          <table class="table table-sm">
            <tr>
              <th class="text-left" v-html="documentLabels.process"></th>
              <td class="text-left" v-html="document.process"></td>
            </tr>
            <tr>
              <th class="text-left" v-html="documentLabels.title_en"></th>
              <td class="text-left">${document.title_en|nz}</td>
            </tr>
            <tr>
              <th class="text-left" v-html="documentLabels.title_fr"></th>
              <td class="text-left">${document.title_fr|nz}</td>
            </tr>
            <tr>
              <th class="text-left" v-html="documentLabels.title_in"></th>
              <td class="text-left">${document.title_in|nz}</td>
            </tr>
            <tr>
              <th class="text-left">{% trans "Type" %}</th>
              <td class="text-left" v-html="document.type_display"></td>
            </tr>
            <tr>
              <th class="text-left">{% trans "Status" %}</th>
              <td class="text-left" v-html="document.status_display"></td>
            </tr>

            <tr>
              <th class="text-left" v-html="documentLabels.series"></th>
              <td class="text-left">${document.series|nz}</td>
            </tr>
            <tr>
              <th class="text-left" v-html="documentLabels.year"></th>
              <td class="text-left">${document.year|nz}</td>
            </tr>
            <tr>
              <th class="text-left" v-html="documentLabels.pub_number"></th>
              <td class="text-left">${document.pub_number|nz}</td>
            </tr>
            <tr>
              <th class="text-left" v-html="documentLabels.pages"></th>
              <td class="text-left">${document.pages|nz}</td>
            </tr>
            <tr>
              <th class="text-left" v-html="documentLabels.hide_from_list"></th>
              <td class="text-left">${document.hide_from_list|yesNo}</td>
            </tr>
            <tr>
              <th>{% trans "Linked meetings" %}</th>
              <td>
                {% if object.meetings.exists %}
                  {% for obj in object.meetings.all %}
                    <div>
                      <a href="{% url 'csas2:meeting_detail' obj.id %}">{{ obj }}</a>
                    </div>
                  {% endfor %}
                {% else %}
                  <em>{% trans "There are no meetings linked to this document." %}</em>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th class="text-left">{% trans "Metadata" %}</th>
              <td class="text-left" v-html="document.metadata"></td>
            </tr>
          </table>
        </div>

        <div class="mb-5">
          {% include "csas2/document_detail/_authors.html" %}
        </div>


        <div class="mb-5">
          {% include "csas2/document_detail/_costs.html" %}
        </div>
      </div>

      {# Notes #}
      <div class="col">
        {% include "csas2/document_detail/_notes.html" %}
      </div>


    </div>

  </div>




{% endblock %}


{% block body_js %}
  {{ block.super }}

  {% include "csas2/document_detail/components/note_editor.html" %}
  {% include "csas2/document_detail/components/note_card.html" %}
  {% include "csas2/document_detail/components/cost_editor.html" %}
  {% include "csas2/document_detail/components/author_editor.html" %}

  <script type="application/javascript">
  var documentId = "{{ object.id }}";

  // register components
  Vue.component('v-select', VueSelect.VueSelect);

  // vuejs instance
  var app = new Vue({
    el: '#app',
    delimiters: ["${", "}"],
    data: {
      currentUser: {},
      canModify: false,
      loadingDocument: false,

      document: {},
      notes: [],
      authors: [],
      costs: [],

      showNoteModal: false,
      showAuthorModal: false,
      showCostModal: false,
      documentId: documentId,
      documentLabels: {}
    },
    methods: {
      getCurrentUser() {
        let endpoint = `/api/csas/user/`;
        apiService(endpoint)
            .then(response => {
              this.currentUser = response;
            })
      },
      openPopout(url) {
        popitup(url, 'popoutWindow' + Date.now());
      },
      deleteCost(resource) {
        let userInput = confirm("{% trans 'Are you certain you want to delete this resource?' %}")
        if (userInput) {
          let endpoint = `/api/csas/costs/${resource.id}/`;
          apiService(endpoint, "DELETE").then(() => {
            this.getCosts();
          })
        }
      },
      getDocumentMetadata() {
        let endpoint = `/api/csas/meta/models/document/`;
        apiService(endpoint).then(data => {
          this.documentLabels = data.labels;
        });
      },
      deleteAuthor(invitee) {
        let userInput = confirm("{% trans 'Are you certain you want to delete this invitee?' %}")
        if (userInput) {
          let endpoint = `/api/csas/authors/${invitee.id}/`;
          apiService(endpoint, "DELETE").then(() => {
            this.getAuthors();
          })
        }
      },
      getNotes() {
        let endpoint = `/api/csas/doc-notes/?document=${this.document.id}`;
        apiService(endpoint).then(data => {
          this.notes = data;
        });
      },
      getAuthors() {
        let endpoint = `/api/csas/authors/?document=${this.document.id}`;
        apiService(endpoint).then(data => {
          this.authors = data;
        });
      },
      getCosts() {
        let endpoint = `/api/csas/doc-costs/?document=${this.document.id}`;
        apiService(endpoint).then(data => {
          this.costs = data;
        });
      },
      getDocument(update_notes) {
        let endpoint = `/api/csas/documents/${this.documentId}/`;
        apiService(endpoint).then(data => {
          if (data) {
            this.document = data;
            if (update_notes) this.notes = this.getNotes();
            this.authors = this.getAuthors();
            this.costs = this.getCosts();
          }
        });
      },
    },
    computed: {},
    filters: {
      yesNo: vueFiltersObject["yesNo"],
      nz: vueFiltersObject["nz"],
    },
    created() {
      this.getDocumentMetadata();
      this.getDocument(true);
    },
  });


  </script>

  {# Modals #}

{% endblock %}