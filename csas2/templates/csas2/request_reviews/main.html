{% extends "csas2/base.html" %}
{% load static %}
{% load bootstrap4 %}
{% load verbose_names %}
{% load custom_filters %}
{% load i18n %}

{% block crumbs %}
{% endblock %}

{% block messages %}{% endblock %}
{% block title_area %}
{% endblock %}


{% block subcontent %}
  <div id="app" v-cloak>

    {% include "shared_models/_generic_breadcrumbs.html" %}
    <div class="mb-3">
      <h2 class="">{{ h1|safe }}</h2>
    </div>
    {% bootstrap_messages %}

    {% include "csas2/request_reviews/_filter.html" %}
    <div v-if="loadingRequests" class="loading mb-3 mt-3 mt-5">
      <div class="spinner-border mb-3" style="width: 5rem; height: 5rem;" role="status">
        <span class="sr-only"></span>
      </div>
    </div>
    <div v-else>
      <div v-if="fresh">
        <div class="mt-5">
          <em class="lead">
            {% trans "Please use the filters to get started..." %}
          </em>
        </div>
      </div>
      <div v-else-if="!requests.length">
        <div class="mt-5">
          <em class="lead">
            {% trans "No requests found..." %}
          </em>
        </div>
      </div>
      <div v-else class="m-3 mt-4">
        <table class="table table-sm">
          <thead>
          <tr>
            <th class="w25">Id</th>
            <th>${requestLabels.fiscal_year}</th>
            <th class="w150">${requestLabels.title}</th>
            <th>{% trans "Region" %}</th>
            <th class="w150">{% trans "Section" %}</th>
            <th>${requestLabels.status}</th>
            <th>${reviewLabels.prioritization}</th>
            <th>${reviewLabels.decision}</th>
            <th>${reviewLabels.decision_text}</th>
            <th>${reviewLabels.advice_date}</th>
            <th>${reviewLabels.is_deferred}</th>
            <th>${reviewLabels.deferred_text}</th>
            <th>${reviewLabels.notes}</th>
          </tr>
          </thead>
          <tbody>
          <tr v-for="r in requests" :key="r.id">
            <td>${r.id}</td>
            <td>${r.fiscal_year}</td>
            <td>${r.title}</td>
            <td>${r.region}</td>
            <td>${r.section_display}</td>
            <td>${r.status_display}</td>
            <td>
              <v-select
                v-if="r.review"
                style="width: 100%"
                v-model="r.review.prioritization"
                @input="updateReview(r)"
                :options="prioritizationChoices"
                :reduce="choice => choice.value"
                label="text"
                :clearable="false"
                class="bg-light"
              >
              </v-select>
            </td>
            <td>
              <v-select
                v-if="r.review"
                style="width: 100%"
                v-model="r.review.decision"
                @input="updateReview(r)"
                :options="decisionChoices"
                :reduce="choice => choice.value"
                label="text"
                :clearable="false"
                class="bg-light"
              >
              </v-select>
            </td>
            <td>
              <textarea rows="3" class="form-control" v-model="r.review.decision_text" @change="updateReview"></textarea>
            </td>
            <td>
              <input v-model="r.review.advice_date_display" type="date" class="form-control" placeholder="{% trans "Click to select dates" %}"
                     @change="updateReview">
            </td>
            <td>
                  <input v-model="r.review.is_deferred" class="" type="checkbox" id="is_deferred" @change="updateReview">
            </td>
            <td>
                  <textarea rows="3" class="form-control" v-model="r.review.deferred_text" @change="updateReview"></textarea>
            </td>
            <td>
                  <textarea rows="8" class="form-control" v-model="r.review.notes" @change="updateReview"></textarea>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
    {#    <div v-if="canModify && request.review && request.review.id" :class="{'sidebar-opened':showSidebar,'sidebar-closed':!showSidebar}">#}
    {#      {% include "csas2/request_detail/_review.html" %}#}
    {#    </div>#}
    {#    <div class="row">#}
    {#      <div>#}
    {#        <div>#}

    {##}
    {#          <div v-if="canModify" class="alert alert-primary no-print" role="alert">#}
    {#            <p class="mb-0">#}
    {#              <span class="h5 mdi mdi-information-outline mr-3"></span> <span class="h6">${currentUser.can_modify.reason}</span>#}
    {#            </p>#}
    {#          </div>#}
    {##}
    {#          <div class="mb-3 float-right">#}
    {#            {% if object.submission_date %}#}
    {#              <button v-if="!request.review" class="btn btn-sm btn-dark" @click="primeReview">{% trans "Start a Review" %}</button>#}
    {#              {% if not object.processes.exists %}#}
    {#                <a v-if="canModify" class="btn btn-sm btn-dark" href="{% url 'csas2:process_new' %}?request={{ object.id }}">{% trans "Start a Process" %}</a>#}
    {#              {% endif %}#}
    {#            {% endif %}#}
    {#          </div>#}
    {#          <div class="mb-3">#}
    {#            <a v-if="canModify" class="btn btn-sm btn-warning" href="{% url 'csas2:request_edit' object.id %}">{% trans "Edit" %}</a>#}
    {##}
    {#            <span v-if="canModify">#}
    {#              <a v-if="request.submission_date" class="btn btn-sm btn-primary" href="{% url 'csas2:request_submit' object.id %}">#}
    {#                {% trans "Un-Submit" %}#}
    {#              </a>#}
    {#              <a v-else-if="request.is_complete" class="btn btn-sm btn-primary" href="{% url 'csas2:request_submit' object.id %}">#}
    {#                {% trans "Submit" %}#}
    {#              </a>#}
    {#              <span v-else  class="helper" data-toggle="tooltip" title="{% trans "All fields are mandatory before approvals and submission" %}">#}
    {#                <a  class="btn btn-sm btn-primary disabled" href="{% url 'csas2:request_submit' object.id %}">#}
    {#                  {% trans "Submit" %}#}
    {#                </a>#}
    {#              </span>#}
    {#            </span>#}
    {##}
    {#            <a v-if="canModify" class="btn btn-sm btn-danger" href="{% url 'csas2:request_delete' object.id %}">{% trans "Delete" %}</a>#}
    {#            <a class="btn btn-sm btn-secondary helper"#}
    {#               data-toggle="tooltip" title="{% trans "Click here to clone this request into a new request" %}"#}
    {#               href="{% url 'csas2:request_clone' object.id %}">{% trans "Clone Me" %}</a>#}
    {#            <button v-if="canModify" @click="openPopout('{% url 'csas2:request_file_new' object.id %}')" class="btn btn-outline-dark btn-sm ml-3">#}
    {#              <span class="mdi mdi-file mr-1"></span>{% trans "Add a File" %}#}
    {#            </button>#}
    {#            {% if object.status >= 2 %}#}
    {##}
    {#              <a href="{% url 'csas2:request_pdf' %}?csas_requests={{ object.id }}" class="btn btn-outline-dark btn-sm ml-3">#}
    {#                <span class="mdi mdi-file-pdf mr-1"></span>{% trans "Export to PDF" %}#}
    {#              </a>#}
    {#            {% endif %}#}
    {#          </div>#}
    {##}
    {#          <div class="row">#}
    {#            <div class="col">#}
    {#              <table class="table table-sm">#}
    {#                <tr>#}
    {#                  <th class="text-left w250" v-html="requestLabels.fiscal_year"></th>#}
    {#                  <td class="text-left" v-html="request.fiscal_year"></td>#}
    {#                </tr>#}
    {#                <tr>#}
    {#                  <th class="text-left w250" v-html="requestLabels.status"></th>#}
    {#                  <td class="text-left" v-html="request.status_display_html"></td>#}
    {#                </tr>#}
    {#                <tr>#}
    {#                  <th class="text-left">{% trans "is carry over?" %}</th>#}
    {#                  <td class="text-left">${request.is_carry_over|yesNo}</td>#}
    {#                </tr>#}
    {#                <tr>#}
    {#                  <th class="text-left" v-html="requestLabels.language"></th>#}
    {#                  <td class="text-left" v-html="request.language_display"></td>#}
    {#                </tr>#}
    {#                <tr>#}
    {#                  <th class="text-left" v-html="requestLabels.section"></th>#}
    {#                  <td class="text-left" v-html="request.section_display"></td>#}
    {#                </tr>#}
    {#                <tr>#}
    {#                  <th class="text-left" v-html="requestLabels.coordinator"></th>#}
    {#                  <td class="text-left" v-html="request.coordinator"></td>#}
    {#                </tr>#}
    {#                <tr>#}
    {#                  <th class="text-left" v-html="requestLabels.client"></th>#}
    {#                  <td class="text-left" v-html="request.client"></td>#}
    {#                </tr>#}
    {#                <tr>#}
    {#                  <th class="text-left">{% trans "Multiregional / multisector?" %}</th>#}
    {#                  <td class="text-left" v-html="request.multiregional_display"></td>#}
    {#                </tr>#}
    {#                <tr>#}
    {#                  <th class="text-left" v-html="requestLabels.issue"></th>#}
    {#                  <td class="text-left" v-html="request.issue_html"></td>#}
    {#                </tr>#}
    {#                <tr>#}
    {#                  <th class="text-left">{% trans "Assistance from DFO Science" %}</th>#}
    {#                  <td class="text-left" v-html="request.assistance_text"></td>#}
    {#                </tr>#}
    {#                <tr>#}
    {#                  <th class="text-left" v-html="requestLabels.rationale"></th>#}
    {#                  <td class="text-left" v-html="request.rationale_html"></td>#}
    {#                </tr>#}
    {#                <tr>#}
    {#                  <th class="text-left" v-html="requestLabels.risk_text"></th>#}
    {#                  <td class="text-left" v-html="request.risk_text_html"></td>#}
    {#                </tr>#}
    {#                <tr>#}
    {#                  <th class="text-left" v-html="requestLabels.advice_needed_by"></th>#}
    {#                  <td class="text-left" v-html="request.advice_needed_by_display"></td>#}
    {#                </tr>#}
    {#                <tr>#}
    {#                  <th class="text-left" v-html="requestLabels.rationale_for_timeline"></th>#}
    {#                  <td class="text-left" v-html="request.rationale_for_timeline"></td>#}
    {#                </tr>#}
    {#                <tr>#}
    {#                  <th class="text-left">{% trans "Client funding?" %}</th>#}
    {#                  <td class="text-left" v-html="request.funding_display"></td>#}
    {#                </tr>#}
    {#                <tr>#}
    {#                  <th class="text-left">{% trans "Client prioritization?" %}</th>#}
    {#                  <td class="text-left" v-html="request.prioritization_display"></td>#}
    {#                </tr>#}
    {#                <tr>#}
    {#                  <th class="text-left" v-html="requestLabels.submission_date"></th>#}
    {#                  <td class="text-left" v-html="request.submission_date_display"></td>#}
    {#                </tr>#}
    {#                <tr>#}
    {#                  <th class="text-left" v-html="requestLabels.uuid"></th>#}
    {#                  <td class="text-left" v-html="request.uuid"></td>#}
    {#                </tr>#}
    {#                <tr>#}
    {#                  <th>#}
    {#                    {% trans "Files" %}#}
    {#                  </th>#}
    {#                  <td>#}
    {#                    {% if object.files.exists %}#}
    {#                      {% for file in object.files.all %}#}
    {#                        <div>#}
    {#                          <a href="{{ file.file.url }}">{{ file.caption }}</a> (uploaded on: {{ file.date_created|date:"F d Y" }})#}
    {#                          <button class="btn" @click="openPopout('{% url 'csas2:request_file_edit' file.id %}')" class="ml-3">#}
    {#                            <span class="mdi mdi-pencil" style="font-size: large"></span>#}
    {#                          </button>#}
    {#                          <button class="btn" @click="openPopout('{% url 'csas2:request_file_delete' file.id %}')">#}
    {#                            <span class="mdi mdi-delete" style="font-size: large"></span>#}
    {#                          </button>#}
    {#                        </div>#}
    {#                      {% endfor %}#}
    {#                    {% else %}#}
    {#                      <em>{% trans "There are no files attached to this request." %}</em>#}
    {#                    {% endif %}#}
    {#                  </td>#}
    {#                </tr>#}
    {# files #}
    {#                <tr>#}
    {#                  <th>#}
    {#                    {% trans "Connected processes" %}#}
    {#                  </th>#}
    {#                  <td>#}
    {#                    {% if object.processes.exists %}#}
    {#                      {% for process in object.processes.all %}#}
    {#                        <div>#}
    {#                          {{ process.status_display }} &rarr; <a href="{% url 'csas2:process_detail' process.id %}">{{ process }} ({{ process.id }})</a>#}
    {#                        </div>#}
    {#                      {% endfor %}#}
    {#                    {% else %}#}
    {#                      <em>{% trans "There are no processes attached to this request." %}</em>#}
    {#                    {% endif %}#}
    {#                  </td>#}
    {#                </tr>#}
    {#                <tr>#}
    {#                  <th class="text-left">{% trans "Metadata" %}</th>#}
    {#                  <td class="text-left" v-html="request.metadata"></td>#}
    {#                </tr>#}
    {#              </table>#}
    {#            </div>#}
    {# Notes #}
    {#            <div class="col-4">#}
    {#              <note-pad v-if="request.id" parent_name="request" :parent_id="request.id" :notes="notes" @update-notes="getNotes" :is_admin="canModify"></note-pad>#}
    {#            </div>#}
    {#          </div>#}
    {#        </div>#}
    {#      </div>#}
    {##}
    {#    </div>#}
  </div>


{% endblock %}


{% block body_js %}
  {{ block.super }}
  {% include "csas2/components/filter_control.html" %}

  <script type="application/javascript">

  // register vue-select
  Vue.component('v-select', VueSelect.VueSelect);

  // vuejs instance
  var app = new Vue({
    el: '#app',
    delimiters: ["${", "}"],
    data: {
      currentUser: {},
      loadingRequests: false,
      requests: [],
      requestLabels: {},
      reviewLabels: {},
      errorMsg: null,
      statusChoices: [],
      prioritizationChoices: [],
      decisionChoices: [],
      fyChoices: [],
      regionChoices: [],
      sectorChoices: [],
      fresh: true,
      requestsEndpoint: `/api/csas/requests/?`
    },
    methods: {
      getCurrentUser() {
        let endpoint = `/api/csas/user/`;
        apiService(endpoint)
            .then(response => {
              this.currentUser = response;
            })
      },
      openPopout(url) {
        popitup(url, 'popoutWindow' + Date.now());
      },
      appliedFilter(p, v) {
        if (!v) v = "";
        root = this.requestsEndpoint.split("?")[0]
        params = this.requestsEndpoint.split("?")[1]
        let found = false;
        let newParamArray = [];
        for (const param of params.split("&")) {
          if (!param.includes(p)) newParamArray.push(param);
        }
        this.requestsEndpoint = `${root}?${newParamArray.join("&")}`
        this.requestsEndpoint += `${p}=${v}&`
      },
      getRequests(param, val) {
        this.appliedFilter(param, val);
        this.loadingRequests = true;
        this.fresh = false;
        apiService(this.requestsEndpoint).then(data => {
          if (data) {
            this.requests = data;
            this.loadingRequests = false;
          }
        });
      },
      getRequest(request) {
        let endpoint = `/api/csas/requests/${request.id}/`;
        apiService(endpoint).then(data => {
          if (data) {
            this.$set(this.requests, this.requests.indexOf(request), data)
          }
        });
      },
      getNotes() {
        let endpoint = `/api/csas/request-notes/?csas_request=${requestId}`;
        apiService(endpoint).then(data => {
          this.notes = data;
        });
      },
      primeReview() {
        let endpoint = `/api/csas/request-reviews/`;
        apiService(endpoint, "POST", {csas_request: this.request.id}).then(() => {
          this.getRequest();
        })
      },
      cleanReview(review) {
        for (const reviewKey in review) if (review[reviewKey] === "") review[reviewKey] = null;
        if (review.advice_date_display) review.advice_date = review.advice_date_display + "T12:00:00";
        if (review.advice_date_display) review.decision_date = review.advice_date_display + "T12:00:00";
        return review;
      },
      updateReview(request) {
        this.errorMsg = null;
        review = this.cleanReview(request.review);
        let endpoint = `/api/csas/request-reviews/${review.id}/`;
        apiService(endpoint, "PUT", review).then(data => {
          if (!data.id) this.errors = groomJSON(data);
          else this.getRequest(request);
        });
      },
      //deleteReview() {
      //  let userInput = confirm("{% trans 'Are you certain you want to delete this review?' %}")
      //  if (userInput) {
      //    let endpoint = `/api/csas/request-reviews/${this.request.review.id}/`;
      //    apiService(endpoint, "DELETE").then(() => {
      //      this.getRequest();
      //    })
      //  }
      //},
      getMetadata() {
        apiService(`/api/csas/meta/models/request/`).then(data => {
          this.requestLabels = data.labels;
          this.statusChoices = data.status_choices;
          this.regionChoices = data.region_choices;
          this.sectorChoices = data.sector_choices;
          this.fyChoices = data.fy_choices;
        });
        apiService(`/api/csas/meta/models/request-review/`).then(data => {
          this.reviewLabels = data.labels;
          this.prioritizationChoices = data.prioritization_choices;
          this.decisionChoices = data.decision_choices;
        });
      },
    },
    computed: {
      canModify() {
        return this.currentUser.can_modify && this.currentUser.can_modify.can_modify;
      }
    },
    filters: {
      yesNo: vueFiltersObject["yesNo"],
    },
    created() {
      this.getCurrentUser();
      {#this.getRequest(true);#}
      {#this.getReviewMetadata();#}
      this.getMetadata();
    },
  });


  </script>

{% endblock %}