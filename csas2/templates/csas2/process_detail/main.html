{% extends "csas2/base.html" %}
{% load static %}
{% load bootstrap4 %}
{% load verbose_names %}
{% load custom_filters %}
{% load i18n %}

{% block crumbs %}
{% endblock %}

{% block messages %}{% endblock %}
{% block title_area %}
{% endblock %}

{% block header %}
  {{ block.super }}

{% endblock %}

{% block subcontent %}
  <div id="app" @keydown.esc.prevent="closeModals()" v-cloak>
    <div>
      {% include "shared_models/_generic_breadcrumbs.html" %}
      <div class="mb-3">
        <h2 class="">{{ h1|safe }}</h2>
        <p class="lead text-muted mt-1 mb-0">{% trans "Process ID:" %} {{ object.id }}</p>
      </div>
      {% bootstrap_messages %}
      <div v-if="canModify" class="alert alert-primary no-print" role="alert" style="width: 60%">
        <p class="mb-0">
          <span class="h5 mdi mdi-information-outline mr-3"></span> <span class="h6">${currentUser.reason}</span>
        </p>
      </div>
    </div>

    <div class="mb-3">
      <a class="btn btn-sm btn-warning" href="{% url 'csas2:process_edit' object.id %}">{% trans "Edit" %}</a>
      <a class="btn btn-sm btn-danger" href="{% url 'csas2:process_delete' object.id %}">{% trans "Delete" %}</a>
      <a class="btn btn-sm btn-primary ml-3" href=""><span class="mdi mdi-file-document text-light mr-1"></span>{% trans "Export ToR" %}</a>
    </div>

    <div class="mb-5">
      <table class="table table-sm" style="width: auto">
        {% for field in process_field_list %}
          {% verbose_td_display object field th_width="300px" %}
        {% endfor %}
        {# requests #}
        <tr>
          <th>
            {% trans "Connected requests" %}
          </th>
          <td>
            {% if object.csas_requests.exists %}
              {% for obj in object.csas_requests.all %}
                <div>
                  <a href="{% url 'csas2:request_detail' obj.id %}">{{ obj }}</a>
                </div>
              {% endfor %}
            {% else %}
              <em>{% trans "There are no requests attached to this process." %}</em>
            {% endif %}
          </td>
        </tr>

      </table>
    </div>


    <div class="mb-5">
      <div class="mb-3 float-right">
        <a class="btn btn-sm btn-success" href="{% url 'csas2:meeting_new' object.id %}">{% trans "Add Meeting" %}</a>
      </div>
      <h4>{% trans "Meetings" %}</h4>
      {% if object.meetings.exists %}

        <table class="table table-bordered table-hover table-sm">
          <thead>
          <tr>
            {#          #}
            {% for field in meeting_field_list %}
              <th>{% get_verbose_label object.meetings.first field %}</th>
            {% endfor %}
          </tr>
          </thead>
          <tbody>
          {% for obj in object.meetings.all %}
            <tr @click="followLink('{% url 'csas2:meeting_detail' obj.id %}')" class="pointy">
              {% for field in meeting_field_list %}
                <td>{% get_field_value obj field safe=True %}</td>
              {% endfor %}
            </tr>
          {% endfor %}
          </tbody>
        </table>
      {% else %}
        <em>{% trans "There are no meetings associated with this process." %}</em>
      {% endif %}
    </div>

    <div class="mb-5">
      <div class="mb-3 float-right">
        <a class="btn btn-sm btn-success" href="{% url 'csas2:document_new' object.id %}">{% trans "Add Document" %}</a>
      </div>
      <h4>{% trans "Documents" %}</h4>
      {% if object.documents.exists %}

        <table class="table table-bordered table-hover table-sm">
          <thead>
          <tr>
            <th rowspan="2">{% trans "Title" %}</th>
            <th rowspan="2">{% trans "Type" %}</th>
            <th rowspan="2">{% trans "Status" %}</th>
            <th class="text-center" :colspan="meetings.length">{% trans "Meeting Linkages" %}</th>
          </tr>
          <tr>
            <th v-for="m, index in meetings" :key="m.id" class="text-center text-muted">${m.type_display}</th>
          </tr>
          </thead>
          <tbody>
          <tr v-for="d, index in docs" :key="d.id" @click="goDocumentDetail(d)" class="pointy">
            <td>${d.ttitle}</td>
            <td>${d.type_display}</td>
            <td>${d.status_display}</td>
            <td v-for="m, index in meetings" :key="m.id" class="text-center">
              <button v-if="d.meetings.includes(m.id)" @click="toggleMeetingLinkage(d, m, $event)" class="btn my-0 py-0"><span
                class="py-0 my-0 mdi mdi-checkbox-marked-outline"></span></button>
              <button v-else @click="toggleMeetingLinkage(d, m, $event)" class="btn my-0 py-0"><span class="py-0 my-0 mdi mdi-checkbox-blank-outline"></span>
              </button>
            </td>

          </tr>
          </tbody>
        </table>
      {% else %}
        <em>{% trans "There are no documents associated with this process." %}</em>
      {% endif %}
    </div>

    {# end #}
  </div>




{% endblock %}


{% block body_js %}
  {{ block.super }}
  <script type="application/javascript">
  var processId = "{{ object.id }}"

  // register vue-select
  Vue.component('v-select', VueSelect.VueSelect);

  // vuejs instance
  var app = new Vue({
    el: '#app',
    delimiters: ["${", "}"],
    data: {
      currentUser: {},
      canModify: false,
      loadingDocs: false,
      loadingMeetings: false,
      docs: [],
      meetings: [],
    },
    methods: {
      getCurrentUser() {
        let endpoint = `/api/csas/user/`;
        apiService(endpoint)
            .then(response => {
              this.currentUser = response;
            })
      },
      openPopout(url) {
        popitup(url, 'popoutWindow' + Date.now());
      },
      followLink(url) {
        window.location.href = url;
      },
      goDocumentDetail(document) {
        window.location.href = `/csas2/documents/${document.id}/view/`;
      },
      toggleMeetingLinkage(doc, meeting, event) {
        console.log(event)
        // stop propagation of window change
        event.stopPropagation()
        let endpoint = `/api/csas/documents/${doc.id}/?meeting=${meeting.id}`;
        apiService(endpoint, "POST")
            .then(response => {
              this.getDocuments()
            })
      },
      getDocuments() {
        this.loadingDocs = true;
        let endpoint = `/api/csas/documents/?process=${processId}`;
        apiService(endpoint)
            .then(response => {
              if (response.length && response[0].id) {
                this.docs = response;
                this.loadingDocs = false;
              }
            })
      },
      getMeetings() {
        this.loadingMeetings = true;
        let endpoint = `/api/csas/meetings/?process=${processId}`;
        apiService(endpoint)
            .then(response => {
              if (response.length && response[0].id) {
                this.meetings = response;
                this.loadingMeetings = false;
              }
            })
      },
      updateObservation(obs) {
        this.unsavedChanges = true;
        this.obsErrorMsg = null;
        let endpoint;
        let method;
        if (obs.id) {
          endpoint = `${this.endpointPrefix}/${obs.id}/`;
          method = "PUT";
        } else {
          endpoint = `${this.endpointPrefix}/`;
          method = "POST";
        }
        apiService(endpoint, method, obs)
            .then(response => {
              if (!response.id) this.obsErrorMsg = this.groomJSON(response);
              else {
                if (response.observation_date) response.observation_date = response.observation_date.replace("Z", "")
                this.$set(this.observations, this.observations.indexOf(obs), response)
                this.unsavedChanges = false;
              }
            })
      },
      deleteObservation(obs) {
        userInput = confirm("{% trans 'Are you sure you want to delete this observation?' %}");
        if (userInput) {
          if (obs.id) {
            let endpoint = `${this.endpointPrefix}/${obs.id}/`;
            apiService(endpoint, "DELETE")
                .then(response => {
                  this.$delete(this.observations, this.observations.indexOf(obs));
                })
          } else {
            this.$delete(this.observations, this.observations.indexOf(obs));
            this.unsavedChanges = false;
          }
        }
      },
      groomJSON(json) {
        return JSON.stringify(json).replaceAll("{", "").replaceAll("}", "").replaceAll("[", " ").replaceAll("]", " ").replaceAll('"', "").replaceAll("non_field_errors:", "")
      },

    },
    computed: {},
    created() {
      this.getDocuments();
      this.getMeetings();
    },
  });


  </script>

{% endblock %}